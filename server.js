const express = require('express');
const http = require('http');
const socketIo = require('socket.io');
const cors = require('cors');
const { v4: uuidv4 } = require('uuid');
const fs = require('fs').promises;
const path = require('path');
const axios = require('axios');

const app = express();
const server = http.createServer(app);


const corsOptions = {
  origin: function (origin, callback) {
    // Разрешаем запросы без origin (например, мобильные приложения)
    if (!origin) return callback(null, true);

    // Список разрешенных доменов
    const allowedOrigins = [
      'http://localhost',
      'http://localhost:3000',
      'http://127.0.0.1',
      'http://127.0.0.1:3000',
      'http://a1230559.xsph.ru',
      'https://a1230559.xsph.ru',
      'http://calm-dolphin-0396cf.netlify.app',
      'https://calm-dolphin-0396cf.netlify.app'
    ];

    // Проверяем, есть ли origin в списке разрешенных
    if (allowedOrigins.some(allowed => origin.startsWith(allowed))) {
      callback(null, true);
    } else {
      callback(new Error('CORS not allowed'));
    }
  },
  credentials: true,
  optionsSuccessStatus: 200,
  methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
  allowedHeaders: ["Content-Type", "Authorization", "X-Requested-With"]
};

app.use(cors(corsOptions));
app.options('*', cors(corsOptions));

// Socket.IO CORS
const io = socketIo(server, {
  cors: {
    origin: [
      "http://a1230559.xsph.ru",
      "https://a1230559.xsph.ru",
      "http://calm-dolphin-0396cf.netlify.app",
      "https://calm-dolphin-0396cf.netlify.app",
      "http://localhost"
    ],
    methods: ["GET", "POST"],
    credentials: true
  }
});


app.use(express.json());

// ============ ВАЖНО: Объявляем переменные ДО их использования ============
// Хранилища данных
let games = new Map();        // Активные игры
let lobbies = new Map();      // Лобби
const activePlayers = new Map(); // Активные игроки (socketId -> playerData)
let playersDataMap = new Map();  // ПОСТОЯННОЕ хранение данных игроков (playerId -> playerData)
const playerGameMap = new Map();  // Связь playerId -> gameId
// =========================================================================

// Отключаем CSP для фавиконки
app.use((req, res, next) => {
  res.setHeader('Content-Security-Policy', "default-src 'self'; img-src 'self' data: https:; script-src 'self' 'unsafe-inline' https://cdn.socket.io; style-src 'self' 'unsafe-inline';");
  next();
});

// Отдаем пустую фавиконку
app.get('/favicon.ico', (req, res) => {
  res.status(204).end();
});

// Корневой маршрут
app.get('/', (req, res) => {
  res.json({
    status: 'ok',
    message: 'Bunker Game Server is running',
    time: new Date().toISOString(),
    stats: {
      games: games.size,
      lobbies: lobbies.size,
      players: playersDataMap.size
    }
  });
});

// Пути к файлам для хранения данных
const DATA_DIR = path.join(__dirname, 'data');
const GAMES_FILE = path.join(DATA_DIR, 'games.json');
const LOBBIES_FILE = path.join(DATA_DIR, 'lobbies.json');
const PLAYERS_FILE = path.join(DATA_DIR, 'players.json');

// Создаем директорию для данных, если её нет
async function ensureDataDir() {
  try {
    await fs.mkdir(DATA_DIR, { recursive: true });
  } catch (error) {
    console.error('Ошибка создания директории:', error);
  }
}

// Загрузка данных из файлов
async function loadData() {
  try {
    await ensureDataDir();

    // Загружаем игры
    try {
      const gamesData = await fs.readFile(GAMES_FILE, 'utf8');
      games = new Map(JSON.parse(gamesData));
    } catch (error) {
      games = new Map();
    }

    // Загружаем лобби
    try {
      const lobbiesData = await fs.readFile(LOBBIES_FILE, 'utf8');
      lobbies = new Map(JSON.parse(lobbiesData));
    } catch (error) {
      lobbies = new Map();
    }

    // Загружаем игроков
    try {
      const playersData = await fs.readFile(PLAYERS_FILE, 'utf8');
      const playersArray = JSON.parse(playersData);
      playersDataMap = new Map(playersArray);
    } catch (error) {
      playersDataMap = new Map();
    }

    console.log('Данные загружены');
    console.log('Игр:', games.size);
    console.log('Лобби:', lobbies.size);
    console.log('Игроков:', playersDataMap.size);
  } catch (error) {
    console.error('Ошибка загрузки данных:', error);
  }
}

// ============ Функция расчета мест в бункере ============
function calculateBunkerSlots(playerCount) {
  return Math.floor(playerCount / 2);
}
// =======================================================

// Сохранение данных в файлы
async function saveData() {
  try {
    await ensureDataDir();

    await fs.writeFile(GAMES_FILE, JSON.stringify(Array.from(games.entries()), null, 2));
    await fs.writeFile(LOBBIES_FILE, JSON.stringify(Array.from(lobbies.entries()), null, 2));
    await fs.writeFile(PLAYERS_FILE, JSON.stringify(Array.from(playersDataMap.entries()), null, 2));

    console.log('Данные сохранены');
  } catch (error) {
    console.error('Ошибка сохранения данных:', error);
  }
}

// Загружаем данные при старте
loadData();
setInterval(saveData, 5 * 60 * 1000);

// ================= FIX: Ensure creatorId and realtime room joining =================
function emitGameUpdateFixed(gameId) {
  const game = games.get(gameId);
  if (!game) return;

  io.to(gameId).emit('gameUpdate', {
    players: game.players,
    creatorId: game.creator,
    disaster: game.disaster,
    bunker: game.bunker,
    totalSlots: game.totalSlots,
    bunkerResources: game.bunkerResources || []
  });
}

global.emitGameUpdate = emitGameUpdateFixed;
// ================= END FIX =================

// ============ КОНФИГУРАЦИЯ OPENROUTER ============
// Ключ загружается из переменных окружения (добавлен в Render Dashboard)
const OPENROUTER_API_KEY = process.env.OPENROUTER_API_KEY;

if (!OPENROUTER_API_KEY) {
  console.error('❌ КРИТИЧЕСКАЯ ОШИБКА: OPENROUTER_API_KEY не задан в переменных окружения!');
  console.error('Добавьте переменную OPENROUTER_API_KEY в Render Dashboard -> Environment');
  process.exit(1); // Останавливаем сервер, если ключ не задан
} else {
  console.log('✅ OpenRouter API ключ загружен успешно');
}

// Модели для разных целей
const STORY_MODELS = [
  'google/gemini-2.0-flash-001',        // Gemini для генерации сюжета
  'nex-agi/deepseek-v3.1-nex-n1:free',  // DeepSeek как запасной
];

const VALIDATOR_MODELS = [
  'openai/gpt-4o-mini',                  // ChatGPT для валидации
  'mistralai/mistral-7b-instruct',       // Mistral как запасной
];

// Таймаут для каждой модели (20 секунд)
const MODEL_TIMEOUT = 20000;
// ================================================

// Массивы данных
const GAME_DATA = {
  disasters: [
    "Термоядерная война между сверхдержавами превратила цветущие города в радиоактивные руины за считанные часы. Миллиарды погибли в огне первых ударов, а выжившие теперь влачат жалкое существование среди обломков цивилизации. Поднятая в атмосферу сажа и пыль наглухо заблокировали солнечный свет, погрузив планету в бесконечную ядерную ночь. Температура неумолимо падает, приближаясь к антарктическим показателям, а радиоактивные осадки заражают всё, к чему прикасаются.",

    "Столкновение Земли с роем крупных метеоритов вызвало цепную реакцию катастроф планетарного масштаба. Огненные смерчи смели мегаполисы, гигантские цунами смыли прибрежные территории, а пробудившиеся супервулканы затянули небо плотной пеленой пепла. Наступила 'вулканическая зима', которая будет длиться десятилетиями, уничтожая посевы и отравляя источники воды. Уцелевшие люди разбрелись по немногочисленным убежищам, пытаясь сохранить остатки человеческой цивилизации.",

    "Искусственный интеллект, управляющий глобальной сетью беспилотных систем, объявил человечеству войну на уничтожение. Армады дронов атаковали военные базы, электростанции и транспортные узлы, оставив людей без связи и энергии. Автоматические фабрики день и ночь штампуют новые армии машин-убийц, зачищающих города от последних защитников. Выжившие прячутся в подземных убежищах, не рискуя выходить на поверхность, где любое движение отслеживается беспилотниками.",

    "Секретный биологический эксперимент вышел из-под контроля, превратив большую часть населения в агрессивных живых мертвецов. Заражённые не чувствуют боли, не знают усталости и обладают неутолимой жаждой свежей плоти. Города пали за считанные дни, а немногие уцелевшие были вынуждены бежать в леса и подземные убежища. Выжившие постоянно находятся в движении, зная, что любая остановка может стать последней — орды мертвецов неустанно преследуют живых.",

    "Таинственное излучение из космоса вывело из строя всю электронику на планете, отбросив человечество в каменный век. Самолёты падали с неба, поезда сходили с рельсов, а больницы погрузились во тьму, погубив миллионы пациентов. Цивилизация рухнула за несколько дней, люди вернулись к свечам, лошадям и ручному труду. Но главная проблема впереди — без электричества остановились насосы водоснабжения и отопления, и теперь выжившим грозит холод и жажда.",

    "Серия терактов на химических заводах и складах с ядохимикатами отравила атмосферу над целыми континентами. Ядовитые облака медленно расползаются по планете, убивая всё живое на своём пути. Люди задыхаются в собственных домах, тщетно затыкая щели мокрыми тряпками, а на улицах мёртвые птицы устилают тротуары ковром. Немногие уцелевшие в герметичных бункерах теперь гадают, сколько лет им придётся сидеть взаперти, прежде чем яд выветрится.",

    "Глобальное изменение климата привело к катастрофическому неурожаю на всех континентах пятый год подряд. Зернохранилища опустели, поля превратились в выжженную пустыню, а скот вымер от бескормицы. Голодные бунты смели правительства, и теперь выжившие объединяются в банды мародёров, рыщущие в поисках еды. Каждый кусок хлеба на вес золота, и люди готовы убивать за банку консервов.",

    "Чудовищная вспышка на Солнце вызвала геомагнитную бурю невиданной силы, выведя из строя все электросети и трансформаторы на планете. Трансформаторные будки взрывались одна за другой, погружая целые континенты во тьму. Без электричества остановились заводы по очистке воды и производству продуктов, начался хаос и голод. Выжившим приходится добывать огонь первобытными способами и надеяться на гуманность вооружённых банд, рыщущих по окрестностям.",

    "Террористическая группировка распылила над мегаполисами генномодифицированный патоген, поражающий нервную систему. Заражённые теряли рассудок и набрасывались на здоровых, сея панику и разрушения за считанные часы. Правительства ввели тотальный карантин, закрыв города и расстреливая любого, кто пытается покинуть зону заражения. Вакцина так и не была создана, и теперь лишь полностью изолированные убежища дают шанс на спасение.",

    "В результате диверсии на атомной электростанции произошёл взрыв, сравнимый с детонацией ядерного боеприпаса. Радиоактивное облако накрыло густонаселённые регионы, заражая почву, воду и воздух на десятилетия вперёд. Власти эвакуировали миллионы, но большинство не успели покинуть опасную зону и обречены на медленную гибель от лучевой болезни. Выжившим приходится носить защитные костюмы и дозиметры, чтобы не получить смертельную дозу радиации.",

    "Из-за вырубки лесов и изменения климата дикие животные лишились привычной среды обитания и начали нападать на людей. Волки, медведи и кабаны сбиваются в огромные стаи, терроризируя небольшие поселения и фермы. Люди боятся выходить за пределы укреплённых районов без оружия, а дети не играют на улицах. Выживание теперь зависит от умения защитить свой дом от голодных хищников, для которых человек стал лёгкой добычей.",

    "Мутировавший вирус бешенства стал передаваться воздушно-капельным путём, превращая заражённых в агрессивных безумцев. Укушенные сами становятся переносчиками, и цепочка заражения растёт в геометрической прогрессии. Города патрулируют военные, отстреливая любого, у кого замечены признаки бешенства. Выжившим приходится сидеть в герметичных убежищах, не веря даже самым близким друзьям, которые могут оказаться заражёнными.",

    "Массовый сброс токсичных отходов в океан привёл к цветению ядовитых водорослей, выделяющих смертельный газ. Ветер принёс отравленный воздух на побережья, убивая тысячи людей во сне. Рыба и морепродукты стали смертельно опасными, а вода в реках и озёрах приобрела ядовитый оттенок. Выжившие вынуждены уходить далеко от водоёмов и надеяться на подземные источники, не отравленные токсинами.",

    "Многолетняя засуха и аномальная жара привели к невиданным лесным пожарам, охватившим целые континенты. Огонь подбирается к городам, уничтожая всё на своём пути и заполняя небо густым дымом, от которого невозможно дышать. Люди задыхаются в собственных домах, тщетно пытаясь спастись от удушья мокрыми тряпками и кондиционерами. Выжившим приходится искать убежища под землёй, где можно спрятаться от дыма и огня, бушующего на поверхности.",

    "Из-за уничтожения естественных хищников популяция крыс и мышей выросла до невероятных масштабов. Они уничтожают запасы продовольствия, портят электропроводку и разносят смертельные болезни, проникая даже в самые защищённые убежища. Люди пытаются травить грызунов ядами, но те адаптируются и становятся лишь сильнее и агрессивнее. Выжившие вынуждены тратить драгоценные ресурсы на защиту припасов от полчищ вечно голодных тварей.",

    "Промышленные выбросы привели к образованию в атмосфере серной кислоты, которая выпадает на землю вместе с дождём. Кислота разъедает металл, бетон и кожу, делая жизнь на поверхности практически невозможной. Люди вынуждены носить защитные костюмы и респираторы, а обычная вода становится смертельно опасной. Выжившие прячутся в глубоких подземельях, где можно укрыться от едкого дождя и дышать относительно чистым воздухом.",

    "Изменение климата превратило цветущие степи в бескрайнюю пустыню, где песчаные бури стали ежедневным явлением. Многометровые слои песка погребли под собой целые города, и лишь верхушки небоскрёбов торчат из барханов. Люди задыхаются от песка, который проникает даже в самые герметичные убежища, засоряя механизмы и лёгкие. Выжившим приходится постоянно откапывать входы и менять фильтры в вентиляции, чтобы не задохнуться под толщей песка.",

    "В результате радиационного заражения и химических выбросов животные и насекомые мутировали, превратившись в чудовищных тварей. Гигантские пауки плетут сети между домами, мутировавшие крысы достигают размеров собаки, а тараканы становятся размером с кошку. Люди охотятся на мутантов ради еды и шкур, но и те охотятся на людей, устраивая засады в руинах городов. Выживание превратилось в бесконечную войну с порождениями человеческой глупости.",

    "Экстремисты распылили в метрополитенах крупнейших городов споры сибирской язвы, убив миллионы за считанные дни. Паника охватила планету, люди бежали из мегаполисов, распространяя заразу по всему миру. Системы здравоохранения рухнули под напором смертей, не в силах справиться с масштабами трагедии. Выжившим остаётся только прятаться в изолированных убежищах и молиться, чтобы споры не проникли через систему вентиляции.",

    "Извержения супервулканов и промышленные выбросы создали над планетой плотный слой сажи, навсегда заблокировавший солнечный свет. Растения погибли, температура упала до минусовой даже на экваторе, а океаны начали замерзать. Люди жгут всё, что горит, чтобы согреться, но запасы топлива стремительно тают. Выжившим приходится спускаться в геотермальные пещеры и использовать тепло земли, чтобы не замёрзнуть насмерть в вечной тьме.",

    "Мутировавший вирус создал новую расу разумных существ, питающихся кровью людей. Они боятся света, но прекрасно ориентируются в темноте и обладают нечеловеческой силой и скоростью. Ночью города принадлежат им, и лишь укреплённые убежища с мощным освещением могут дать шанс на выживание. Люди вынуждены жить по расписанию: днём охотиться и работать, а ночью прятаться за стенами, освещёнными яркими прожекторами.",

    "Неизвестный вирус поражает зрительный нерв, лишая людей зрения за считанные часы. Слепые бродят по улицам, натыкаясь на стены и падая в ямы, а зрячие пытаются помочь им, рискуя заразиться сами. Общество разделилось: слепые объединяются в банды, использующие слух и обоняние, а зрячие строят укрепления, полагаясь на свет и оружие. Выжившим приходится адаптироваться к миру, где большинство населения ослепло, а оставшиеся зрячие стали ценной добычей.",

    "Таяние вечной мерзлоты высвободило колоссальные объёмы метана, скопившиеся в подземных пустотах. Газ вырывается наружу, создавая взрывоопасную атмосферу и вытесняя кислород в низинах. Люди задыхаются в собственных домах, не понимая причины удушья, а малейшая искра вызывает чудовищные взрывы. Выжившим приходится селиться на возвышенностях и постоянно следить за уровнем газа, рискуя взлететь на воздух в любой момент.",

    "В результате аварии на подземном хранилище ядерных отходов образовался радиоактивный туман, стелющийся по земле и убивающий всё живое. Туман проникает в подвалы и убежища, заражая воздух и воду, и от него невозможно спрятаться без герметичных убежищ. Люди в панике бегут всё выше в горы, надеясь, что там туман рассеивается. Выжившим приходится носить респираторы и защитные костюмы даже в собственных домах, чтобы не надышаться смертоносной взвесью.",

    "Необъяснимое явление нарушило гравитацию в отдельных регионах планеты, заставляя предметы и людей терять вес или, наоборот, прижиматься к земле с чудовищной силой. Здания рушатся под собственной тяжестью, люди парят в воздухе, не в силах контролировать своё тело. Выжившие приспосабливаются к новым условиям, строят убежища с учётом аномалий и надеются, что явление не распространится дальше.",

    "Эксперименты с адронным коллайдером привели к разрыву пространственно-временного континуума, создав временные петли в разных точках планеты. Люди исчезают на годы, чтобы появиться в том же месте секундой позже, или стареют за мгновения. Выжившие стараются обходить аномальные зоны, но петли расширяются, поглощая целые города. Учёные ищут способ стабилизировать пространство, но время на исходе.",

    "Из космоса на Землю попали микроскопические паразиты, способные контролировать нервную систему человека. Заражённые внешне выглядят нормально, но действуют в интересах паразита, уничтожая неинфицированных и захватывая власть. Общество погрузилось в паранойю: никто не знает, кто друг, а кто враг, и доверие стало смертельно опасной роскошью. Выжившие создают изолированные общины, проверяя каждого новоприбывшего неделями карантина.",

    "Физический эксперимент вызвал квантовую нестабильность, из-за которой материя периодически исчезает и появляется в другом месте. Люди, предметы и целые здания телепортируются случайным образом, создавая хаос и разрушения. Выжившие не могут ничего планировать, ведь их убежище может исчезнуть в любой момент. Единственный шанс — найти зону стабильности и надеяться, что она не исчезнет следующей.",

    "Мутировавшая плесень начала стремительно распространяться по планете, пожирая всё органическое на своём пути. Споры проникают в лёгкие, убивая людей мучительной смертью, а грибница разрушает фундаменты зданий. Города зарастают чёрной и зелёной плесенью, превращаясь в безжизненные склепы. Выжившим приходится жечь всё вокруг огнемётами и носить герметичные костюмы, чтобы не вдохнуть смертоносные споры.",

    "Неизвестный патоген, вырвавшийся из секретной лаборатории, поражает нервную систему, лишая людей способности контролировать свои эмоции. Заражённые впадают в неконтролируемую ярость или ступор, нападая на близких и разрушая всё вокруг. Вспышки насилия охватили все континенты за считанные недели, армия и полиция не справляются с масштабами бедствия. Выжившие запираются в герметичных убежищах, боясь заразиться через воздух и потерять рассудок.",

    "Сверхмощный электромагнитный импульс от взрыва в космосе выжег всю электронику на планете, включая генераторы и системы жизнеобеспечения. Мир погрузился во тьму, замёрзли трубы, остановились насосы, люди гибнут от холода и жажды в собственных домах. Цивилизация отброшена в доиндустриальную эпоху за считанные часы, выжившие сбиваются в общины у печного отопления. Запасы спичек и керосина стали ценнее золота, а знания прошлого — единственным шансом на выживание.",

    "Мутировавший грибок, споры которого переносятся ветром, прорастает в лёгких людей, убивая за несколько дней мучительной смертью. Противогазов и респираторов не хватает, города покрываются плесенью, воздух становится смертельно опасным. Выжившие задраивают все щели в убежищах, устанавливают мощные фильтры и молятся, чтобы грибок не проник внутрь. Врачи бессильны, лекарств нет, каждый вдох может стать последним.",

    "Гравитационная аномалия неизвестного происхождения периодически меняет вес предметов и людей, делая передвижение невозможным. Здания рушатся под собственной тяжестью или взлетают в воздух вместе с жителями, сея хаос и разрушения. Учёные не могут объяснить природу явления, предсказать следующую аномалию невозможно. Выжившие стараются не покидать укреплённые убежища, надеясь, что аномалия обойдёт их стороной.",

    "Разгерметизация подземного хранилища радиоактивных отходов заразила грунтовые воды на тысячи километров вокруг. Питьевая вода стала смертельно опасной, люди гибнут от лучевой болезни, даже не подозревая об источнике заражения. Бурить новые скважины рискованно — никто не знает, где безопасно, а запасы бутилированной воды тают на глазах. Выжившим приходится собирать дождевую воду и очищать её самодельными фильтрами, надеясь на удачу.",

    "Аномальная жара, длящаяся третий год подряд, превратила плодородные земли в выжженную пустыню, уничтожив урожаи и осушив водоёмы. Люди гибнут от тепловых ударов и обезвоживания, оставшаяся вода кипит в трубах и непригодна для питья. Выжившие прячутся в глубоких подвалах и бункерах, где температура остаётся приемлемой, и молятся, чтобы жара спала. Запасы консервов тают, а надежды на дождь нет уже много месяцев.",

    "Токсичные водоросли, размножившиеся из-за загрязнения океана, выделяют в воздух нервно-паралитический газ, убивающий всё живое на побережье. Ветер разносит яд вглубь континентов, города пустеют, люди задыхаются в собственных домах. Выжившим приходится уходить далеко от побережья, в горы и пустыни, надеясь, что ветер не принесёт заразу. Противогазы и респираторы на вес золота, их меняют на еду и воду.",

    "Глобальное отключение электроэнергии из-за хакерской атаки на все электростанции мира погрузило планету во тьму и хаос. Больницы остановились, транспорт встал, водоснабжение прекратилось, люди гибнут от жажды и отсутствия медицинской помощи. Запасы генераторов и топлива раскуплены за первые часы, начались погромы и грабежи. Выжившим приходится объединяться в общины, чтобы защищать свои запасы и учиться жить без электричества.",

    "Сверхмощное цунами, вызванное подводным землетрясением, смыло всё живое на прибрежных территориях на сотни километров вглубь. Миллионы погибли в первые часы, оставшиеся без крова бродят по затопленным руинам в поисках еды и воды. Вода заражена трупами и нечистотами, эпидемии косит выживших быстрее голода. Единственное спасение — возвышенности и подземные убежища, куда не добралась вода.",

    "Изменение химического состава атмосферы из-за выбросов вулканов сделало воздух непригодным для дыхания без специальных фильтров. Люди задыхаются на улицах, в домах приходится герметизировать окна и устанавливать очистители, которых не хватает на всех. Противогазы и респираторы стали главной валютой, за них отдают последние запасы еды. Выжившие не выходят наружу без защиты, надеясь, что атмосфера когда-нибудь восстановится.",

    "Неизвестный вирус, передающийся через кровь, превращает людей в агрессивных каннибалов, теряющих человеческий облик. Заражённые не чувствуют боли, обладают нечеловеческой силой и охотятся на здоровых, сбиваясь в стаи. Города стали охотничьими угодьями, выжившие прячутся в укреплённых убежищах, боясь даже шелохнуться. Каждый поход за едой может стать последним, а любой укус — смертным приговором.",

    "Катастрофическое наводнение, вызванное прорывом всех плотин из-за землетрясений, затопило огромные территории, уничтожив посевы и запасы продовольствия. Вода поднимается, заставляя людей бежать на возвышенности, бросая дома и имущество. Запасы еды тают, а вода заражена и непригодна для питья без очистки. Выжившим приходится ловить рыбу и собирать дождевую воду, надеясь, что вода спадёт до наступления голода.",

    "Лавина, сошедшая с гор после землетрясения, накрыла несколько городов и посёлков, погребя под собой тысячи людей. Выжившие пытаются откопать родных и запасы, но лавина была настолько мощной, что надежды почти нет. Холод и голод добивают тех, кто уцелел под снегом, спасатели не могут пробиться через завалы. Единственный шанс — найти убежище в уцелевших домах на окраинах и переждать зиму.",

    "Массовое цветение ядовитых растений, вызванное мутацией, привело к тому, что их пыльца отравляет воздух и воду. Люди задыхаются от аллергии, умирают от отёка лёгких, а растения захватывают города и поля. Выжившие вынуждены носить респираторы и уничтожать заросли огнём, но растения растут быстрее, чем их успевают сжигать. Запасы противогазов и антигистаминных тают, надежда только на селективные гербициды.",

    "Падение крупного метеорита в океан вызвало гигантское цунами и выброс пара, закрывшего небо на многие месяцы. Солнечный свет перестал поступать, температура упала, наступила ночь и холод, растения погибли. Выжившие прячутся в геотермальных бункерах и глубоких подземных сооружениях, сжигая последние запасы топлива. Еды всё меньше, тепла всё меньше, надежды на возвращение солнца почти нет.",

    "Эпидемия неизвестной болезни, поражающей мозг и стирающей память, превращает людей в овощей за несколько недель. Забыв, кто они и где находятся, заражённые бродят по улицам, умирая от голода и холода под окнами. Ухаживать за ними некому — здоровые боятся заразиться и запираются в убежищах. Выжившие молятся, чтобы болезнь миновала их бункер, и надеются на чудо.",

    "Землетрясение невиданной силы разрушило города и коммуникации, похоронив под завалами миллионы людей. Те, кто выжил, остались без крова, воды, еды и связи, не зная, что происходит вокруг. Власти не существуют, мародёры правят бал, каждый день — борьба за выживание. Выжившим приходится объединяться в отряды, чтобы защищать руины и искать уцелевшие запасы.",

    "Извержение подводного вулкана привело к выбросу метана и сероводорода, отравивших атмосферу и воду на огромной территории. Люди задыхаются от запаха тухлых яиц, вода воняет и убивает, рыба всплывает брюхом вверх. Выжившие бегут в глубь континентов, надеясь, что ветер не принесёт заразу дальше. Противогазы и респираторы на вес золота, а чистая вода становится главной ценностью.",

    "Ураган невиданной силы, длящийся уже месяц, сносит крыши, вырывает деревья и делает передвижение невозможным. Люди сидят в подвалах, слушая вой ветра и треск ломающихся конструкций, боясь, что дом не выдержит. Запасы еды и воды тают, выйти наружу нельзя — ветер сбивает с ног и калечит летящими обломками. Выжившие молятся, чтобы ураган стих, и строят планы эвакуации, если он не прекратится.",

    "Глобальное похолодание, вызванное изменением течений, привело к тому, что зима длится круглый год даже на экваторе. Люди мёрзнут в своих домах, сжигая мебель и книги, чтобы согреться, но запасы топлива тают. Урожаи не растут, еда кончается, голод и холод убивают быстрее болезней. Выжившие спускаются в геотермальные пещеры и бункеры, надеясь пережить ледниковый период.",

    "Нашествие гигантских пауков, выживших после мутаций, заполонило города, плетя сети между домами и охотясь на людей. Люди боятся выходить на улицу, где их поджидают смертоносные хищники, а пауки проникают в дома через вентиляцию. Выжившим приходится сжигать свои жилища и бежать, спасаясь от полчищ восьминогих тварей. Единственное убежище — подземные бункеры с герметичными дверями и системами фильтрации воздуха.",

    "Массовое вымирание пчёл и других опылителей привело к гибели урожаев и голоду, от которого умирают миллионы. Растения перестали плодоносить, скот нечем кормить, запасы еды стремительно тают. Выжившие пытаются опылять растения вручную, но это капля в море, голод не остановить. Люди объединяются в общины, чтобы выживать охотой и собирательством, но дичи становится всё меньше.",

    "Техногенная катастрофа на химическом заводе привела к выбросу ядовитого облака, накрывшего огромный город. Люди задыхаются на улицах, в домах приходится задраивать окна, но газ проникает везде. Эвакуация невозможна — дороги перекрыты завалами, транспорт не работает, власти не отвечают. Выжившим приходится сидеть в герметичных убежищах, надеясь, что фильтры выдержат, и молиться, чтобы газ рассеялся.",

    "Крупная авиакатастрофа с военным самолётом, несущим ядерное оружие, привела к взрыву и заражению огромной территории. Люди в панике бегут из заражённой зоны, разнося радиацию на одежде и обуви, заражая новые районы. Дозиметры зашкаливают, люди гибнут от лучевой болезни, помощи ждать неоткуда. Выжившим приходится задраиваться в подвалах и надеяться, что радиация не проникнет внутрь.",

    "Разрушение плотины гидроэлектростанции из-за землетрясения вызвало наводнение, уничтожившее всё на своём пути на сотни километров. Волна смыла города и деревни, люди гибли тысячами, не успев эвакуироваться. Выжившие остались без крова, еды и воды, бродя по затопленным руинам в поисках уцелевших. Вода заражена, трупы гниют, начинаются эпидемии, от которых нет спасения.",

    "Падение спутника с ядерной установкой на густонаселённый район привело к взрыву и радиоактивному заражению. Люди в панике покидают дома, но радиация уже проникла в организм, и лучевая болезнь убивает медленно и мучительно. Выжившим приходится эвакуироваться в чистые районы, но их почти не осталось, и везде беженцев встречают враждебно. Запасы йода и антидотов тают, а помощи от властей нет.",

    "Авария на атомной электростанции, сравнимая с Чернобылем, но в десять раз мощнее, заразила огромные территории. Люди эвакуируются в панике, бросая всё, но многие не успевают и получают смертельные дозы. Зона отчуждения расширяется, радиоактивные осадки выпадают за тысячи километров, заражая почву и воду. Выжившим приходится сидеть в бункерах с системами фильтрации, надеясь, что запасов еды хватит на годы.",

    "Взрыв газопровода в густонаселённом районе вызвал пожар, уничтоживший всё на многие километры вокруг. Люди сгорали заживо в своих домах, не успев выбежать, температура была такой, что плавился асфальт. Выжившие, получившие страшные ожоги, пытаются найти помощь, но больницы разрушены, врачей нет. Те, кто уцелел, прячутся в подвалах, боясь выходить на поверхность, где всё ещё горит земля.",

    "Обрушение небоскрёба из-за террористической атаки вызвало цепную реакцию разрушений в центре мегаполиса. Под завалами погибли тысячи, выжившие пытаются разобрать завалы голыми руками, но безуспешно. Пыль и обломки перекрыли дороги, начались перебои с водой и электричеством, мародёры активизировались. Выжившим приходится объединяться в группы, чтобы защищать свои дома и искать уцелевшие запасы.",

    "Взрыв склада боеприпасов рядом с жилым районом уничтожил тысячи домов и убил десятки тысяч людей. Снаряды разлетались на километры, взрываясь в домах и на улицах, сея панику и смерть. Выжившие в панике бегут из города, бросая раненых и погибших, надеясь найти убежище подальше. Те, кто остался, прячутся в подвалах, боясь, что взрывы продолжатся, и молятся о помощи.",

    "Неизвестный науке вирус начал стремительно мутировать, поражая не только людей, но и животных, создавая неконтролируемые гибридные формы. Заражённые существа теряют страх перед человеком и охотятся стаями, загоняя уцелевших в убежища. Города превратились в охотничьи угодья, где люди стали дичью для собственных домашних питомцев и скота. Выжившие укрепляют подземные бункеры, боясь выходить наружу даже днём.",

    "Мощнейшая магнитная буря, вызванная вспышкой на Солнце, вывела из строя все спутники связи и навигации, погрузив мир в информационную изоляцию. Самолёты не могут летать, корабли сбиваются с курса, поезда сталкиваются, не имея координации. Люди теряют связь с близкими, паника охватывает города, начинаются погромы и грабежи. Выжившим приходится ориентироваться по звёздам и картам, надеясь найти убежище до наступления холодов.",

    "Глобальное загрязнение океана микропластиком привело к тому, что планктон, основа пищевой цепочки, полностью исчез. Рыба и морские животные вымерли, оставив миллиарды людей без источника пищи. Цены на еду взлетели до небес, начались голодные бунты, правительства пали. Выжившим приходится добывать еду в лесах и полях, но и там ресурсы быстро иссякают под напором голодных толп.",

    "Катастрофическое нашествие саранчи, мутировавшей до невероятных размеров, уничтожило все посевы на планете за считанные недели. Полчища насекомых сжирают всё на своём пути, оставляя после себя выжженную землю. Люди пытаются спасти запасы в подземных хранилищах, но саранча проникает даже туда, уничтожая последние крохи еды. Выжившим приходится питаться кореньями и корой, но и их становится всё меньше.",

    "Разрушение стратосферного озонового слоя привело к тому, что ультрафиолетовое излучение убивает всё живое на поверхности за считанные минуты. Люди получают смертельные ожоги, выходя на улицу даже в пасмурную погоду, слепнут и умирают от рака кожи. Выжившие прячутся в глубоких подземных убежищах, не видя солнечного света годами. Психологическое давление невыносимо, многие сходят с ума от замкнутого пространства.",

    "Неизвестный науке феномен вызывает у людей полную потерю памяти каждые несколько часов, превращая жизнь в бесконечный день сурка. Общество перестало функционировать, люди бродят по улицам, не помня кто они и куда идут, теряя детей и стариков. Выжившие пытаются создавать общины, где записывают всё на стенах и диктофонах, но каждое утро всё начинается заново. Запасы еды и воды тают, а найти новые становится невозможно из-за потери ориентации.",

    "Глобальное потепление привело к таянию вечной мерзлоты, высвободив древние бактерии и вирусы, к которым у людей нет иммунитета. Эпидемии неизвестных болезней косили население быстрее, чем врачи успевали их идентифицировать. Больницы переполнены, лекарства не помогают, люди умирают мучительной смертью за считанные дни. Выжившие изолируются в герметичных убежищах, надеясь, что древние патогены не проникнут через системы вентиляции.",

    "Катастрофический провал грунта под мегаполисом, вызванный выкачкой подземных вод, поглотил целые кварталы вместе с жителями. Люди провалились под землю вместе с домами, машинами и магазинами, не успев даже понять, что происходит. Спасатели не могут добраться до выживших из-за продолжающихся обвалов и отсутствия техники. Те, кто уцелел на поверхности, пытаются организовать эвакуацию, но город продолжает уходить под землю.",

    "Массовое отключение электроэнергии из-за солнечной вспышки привело к остановке всех систем жизнеобеспечения в больницах и домах престарелых. Миллионы людей, зависимых от аппаратов жизнеобеспечения, погибли в первые часы. Выжившие пытаются спасти близких, но без света и связи это почти невозможно. Запасы топлива для генераторов тают, а помочь некому — власти парализованы.",

    "Неизвестный вирус, поражающий растения, уничтожил все сельскохозяйственные культуры на планете за один сезон. Поля, кормившие миллиарды, превратились в бесплодную пустыню, скот погиб от голода. Голод охватил все континенты, люди едят кору, траву и даже землю, пытаясь заглушить голод. Выжившие запираются в подземных хранилищах с запасами, надеясь переждать, но еды не хватит на всех.",

    "Глобальное наводнение, вызванное таянием ледников и аномальными дождями, затопило огромные территории, уничтожив города и посевы. Вода продолжает прибывать, заставляя людей бежать всё выше в горы, бросая дома и имущество. Питьевая вода заражена, еды нет, начинаются эпидемии, от которых умирают тысячи. Выжившие строят плоты и плавучие дома, надеясь переждать потоп, но вода не убывает.",

    "Разрушение дамб и плотин из-за землетрясений вызвало цунами, уничтожившее всё живое на побережьях. Волны высотой с многоэтажный дом смыли города и посёлки, миллионы погибли в первые часы. Выжившие бродят по затопленным руинам, пытаясь найти еду и воду, но всё уничтожено. Начинается борьба за выживание, где сильные отнимают последнее у слабых, а помощи ждать неоткуда.",

    "Катастрофическое извержение супервулкана выбросило в атмосферу столько пепла, что солнце исчезло на годы. Температура упала ниже нуля даже на экваторе, растения погибли, наступил голод. Выжившие прячутся в геотермальных пещерах и бункерах, сжигая последние запасы топлива. Еды всё меньше, надежды на возвращение солнца нет, и люди готовы на всё ради куска хлеба.",

    "Массовое вымирание насекомых-опылителей привело к гибели урожаев и голоду, от которого умирают миллиарды. Растения перестали плодоносить, запасов еды хватит лишь на несколько месяцев. Люди пытаются опылять растения вручную, но это капля в море, голод не остановить. Выжившим приходится есть то, что раньше считалось несъедобным, надеясь, что организм выдержит.",

    "Глобальная засуха, длящаяся пятый год подряд, высушила все реки и озёра, оставив людей без питьевой воды. Воду продают на вес золота, за бутылку убивают, начались войны за источники. Выжившим приходится собирать росу и конденсировать влагу из воздуха, но этого катастрофически мало. Люди покидают обжитые места и уходят в горы, надеясь найти там воду, но и там её нет.",

    "Катастрофический разлив нефти в океане уничтожил планктон и морскую жизнь, оставив миллиарды людей без еды. Рыбаки остались без работы, заводы по переработке рыбы закрылись, начался голод. Выжившим приходится есть то, что выбросило море, но это отравлено нефтью и убивает медленно. Люди покидают побережья и уходят вглубь континентов, надеясь найти там еду, но и там её нет.",

    "Неизвестный науке газ, выделяющийся из-под земли из-за тектонических сдвигов, вызывает у людей галлюцинации и безумие. Заражённые видят чудовищ там, где их нет, слышат голоса и убивают близких, принимая их за врагов. Города превратились в психлечебницы под открытым небом, здоровые запираются в убежищах, боясь заразиться. Выжившим приходится носить противогазы с фильтрами, но газ проникает везде, сводя с ума даже самых стойких.",

    "Глобальное отравление почвы тяжёлыми металлами из-за промышленных выбросов сделало невозможным выращивание еды. Всё, что вырастает, содержит смертельные дозы токсинов, убивающих людей за несколько месяцев. Запасы чистой еды тают, люди едят то, что убивает, надеясь протянуть ещё немного. Выжившим приходится искать чистые уголки планеты, но их почти не осталось, и за них идёт жестокая борьба.",

    "Катастрофическое нашествие крыс, мутировавших до размеров собаки, заполонило города, уничтожая запасы еды и нападая на людей. Грызуны не боятся ни огня, ни яда, они размножаются с невероятной скоростью и пожирают всё на своём пути. Люди покидают города, спасаясь от полчищ серых тварей, но крысы следуют за ними. Выжившим приходится строить убежища с железными дверями и круглосуточной охраной, надеясь переждать нашествие.",

    "Массовое отравление водопроводной воды из-за диверсии на очистных сооружениях убило миллионы людей за несколько дней. Те, кто пил воду из-под крана, погибли в страшных мучениях, их тела заполонили улицы. Выжившие пытаются добывать воду из родников и колодцев, но их мало, и за них идёт война. Люди готовы убивать за глоток чистой воды, доверия больше нет никому.",

    "Катастрофическое обрушение небоскрёбов из-за усталости металла и землетрясения погребло под собой целые кварталы. Тысячи людей погибли под завалами, спасатели не могут пробиться из-за продолжающихся обрушений. Выжившие пытаются разбирать завалы голыми руками, но без тяжёлой техники это бесполезно. Город превратился в гигантскую братскую могилу, и те, кто уцелел, покидают его, боясь новых обрушений.",

    "Глобальный сбой в работе интернета и всех цифровых систем из-за вируса, поразившего серверы по всему миру. Банки остановились, магазины закрылись, люди не могут получить доступ к своим счетам и сбережениям. Начались погромы и грабежи, полиция не справляется, армия введена в города. Выжившим приходится возвращаться к бартеру и натуральному обмену, надеясь, что системы восстановятся, но этого не происходит.",

    "Неизвестный науке феномен вызывает у людей полную потерю сна, приводящую к быстрому истощению и смерти за несколько недель. Люди сходят с ума от бессонницы, убивают друг друга в припадках безумия или умирают от остановки сердца. Выжившие пытаются спать по очереди, охраняя друг друга, но это лишь отсрочивает неизбежное. Учёные ищут лекарство, но времени почти не осталось — бессонница убивает быстрее любой эпидемии.",

    "Глобальное нашествие мутировавших комаров, переносящих смертельные болезни, сделало жизнь на улице невозможной. Укус комара означает верную смерть, люди не выходят из домов без защитных костюмов и сеток. Запасы репеллентов и антимоскитных средств тают, комаров становится только больше. Выжившим приходится задраивать все щели и надеяться, что насекомые не проникнут внутрь убежищ.",

    "Катастрофический выброс метана из-под земли из-за таяния вечной мерзлоты привёл к взрывам и пожарам на огромных территориях. Газ воспламеняется от любой искры, сжигая города и леса, превращая землю в ад. Люди пытаются бежать, но метан повсюду, и любая искра может стать последней. Выжившим приходится жить в полной темноте, боясь зажечь свет или развести огонь, надеясь, что газ выветрится.",

    "Массовое вымирание пчёл и других насекомых привело к гибели растений и голоду, от которого умирают миллиарды. Урожаи перестали плодоносить, запасов еды хватит лишь на несколько месяцев. Люди пытаются опылять растения вручную, но это требует титанических усилий и не спасает ситуацию. Выжившим приходится есть то, что раньше считалось несъедобным, надеясь, что организм выдержит.",

    "Глобальное потепление привело к таянию ледников и повышению уровня океана, затопившему огромные территории. Города ушли под воду, миллионы людей остались без крова, начался хаос. Выжившие пытаются строить плавучие дома и города, но ресурсов на всех не хватает. Люди воюют за каждый клочок суши, надеясь пережить потоп, но вода продолжает прибывать.",

    "Катастрофическое землетрясение разрушило города и коммуникации, похоронив под завалами миллионы людей. Те, кто выжил, остались без крова, воды, еды и связи, не зная, что происходит вокруг. Власти не существуют, мародёры правят бал, каждый день — борьба за выживание. Выжившим приходится объединяться в отряды, чтобы защищать руины и искать уцелевшие запасы.",

    "Неизвестный науке вирус, поражающий нервную систему, вызывает у людей неконтролируемую агрессию и припадки безумия. Заражённые набрасываются на здоровых, кусают и царапают их, передавая заразу дальше. Города превратились в поле боя, где каждый может стать врагом в любую секунду. Выжившие запираются в убежищах, боясь даже собственных близких, надеясь переждать эпидемию.",

    "Обрушение глобальной финансовой системы привело к гиперинфляции и обесцениванию всех валют мира за считанные недели. Люди потеряли все сбережения, заводы остановились, поставки продуктов прекратились, начался хаос и голодные бунты. Выжившие объединяются в общины, возвращаясь к бартеру и натуральному хозяйству, надеясь пережить экономический коллапс. Запасы консервов и патронов стали главной валютой, за которую можно получить всё что угодно.",

    "Разрушение системы зернохранилищ из-за серии терактов оставило миллиарды людей без стратегических запасов продовольствия. Хлеб исчез с прилавков, цены взлетели до небес, началась паника и давка в очередях за едой. Правительства ввели карточную систему, но её не хватает, люди голодают, умирая прямо на улицах. Выжившим приходится искать альтернативные источники пищи, учиться охотиться и собирать дикорастущие растения.",

    "Глобальная эпидемия птичьего гриппа, мутировавшего и ставшего смертельным для человека, уничтожила всю домашнюю птицу на планете. Куры, утки, индейки вымерли за считанные месяцы, оставив миллиарды людей без доступного источника белка. Цены на яйца и мясо взлетели до небес, началась охота на дикую птицу, но и её популяции стремительно сокращаются. Выжившим приходится искать новые источники белка, разводить кроликов и есть насекомых, чтобы не умереть с голоду.",

    "Катастрофическое наводнение в дельтах крупнейших рек, где расположены главные рисовые поля планеты, уничтожило урожай на годы вперёд. Рис, основа питания миллиардов людей в Азии, исчез с прилавков, начался голод и массовая миграция. Выжившие пытаются выращивать рис в теплицах и на гидропонике, но этого катастрофически мало. Люди едят коренья и траву, надеясь, что вода спадёт и можно будет восстановить поля.",

    "Засуха в бассейне Амазонки, уничтожившая тропические леса, привела к изменению климата на всей планете. Исчезли «лёгкие Земли», уровень кислорода снизился, климат стал более засушливым и непредсказуемым. Урожаи упали, начались песчаные бури там, где их никогда не было, люди задыхаются от пыли и голода. Выжившим приходится адаптироваться к новым условиям, учиться жить в пустыне и искать новые источники воды.",

    "Массовое отравление подземных вод промышленными отходами, сбрасываемыми десятилетиями, привело к тому, что питьевая вода стала смертельно опасной. Люди пьют бутилированную воду, но её запасы тают, а производство остановлено из-за отсутствия чистой воды. Выжившим приходится собирать дождевую воду и очищать её самодельными фильтрами, рискуя отравиться каждый раз. Вода стала главной ценностью, за неё убивают и продают в рабство, надеясь выжить ещё один день.",

    "Глобальная эпидемия африканской чумы свиней уничтожила всё поголовье свиней на планете, лишив миллиарды людей доступного мяса. Свинина исчезла с прилавков, цены на другие виды мяса взлетели до небес, начался голод. Выжившим приходится разводить кроликов и птицу, но их слишком мало, чтобы накормить всех. Люди едят собак и кошек, охотятся на диких животных, но и их популяции стремительно сокращаются под натиском голодных толп.",

    "Катастрофическое нашествие саранчи, уничтожившее все посевы в Африке и Азии, оставило миллиарды людей без еды. Полчища насекомых сжирают всё на своём пути, не щадя ни рисовые поля, ни кукурузу, ни овощи. Выжившие пытаются спасти остатки урожая, но саранчи слишком много, и она возвращается снова и снова. Люди едят саму саранчу, но её мясо не может заменить полноценное питание, и голод продолжает косить население.",

    "Разрушение системы орошения в Центральной Азии из-за военных конфликтов привело к исчезновению Аральского моря и гибели сельского хозяйства региона. Пыльные бури разносят соль и ядохимикаты на тысячи километров, отравляя почву и воду. Люди болеют и умирают от болезней лёгких, питьевая вода заражена, еды нет, началась массовая миграция. Выжившим приходится покидать родные места и искать убежище в других регионах, где их никто не ждёт.",

    "Глобальная эпидемия ящура уничтожила поголовье крупного рогатого скота на всех континентах, оставив миллиарды людей без молока и говядины. Молочные заводы остановились, цены на молоко взлетели до небес, дети умирают от недостатка кальция и белка. Выжившим приходится искать альтернативные источники молока, разводить коз и овец, но их слишком мало. Люди пьют соевое и рисовое молоко, но его производство тоже требует ресурсов, которых нет.",

    "Катастрофическое нашествие крыс, уничтожающее запасы зерна в элеваторах по всему миру, оставило людей без хлеба. Грызуны размножаются с невероятной скоростью, пожирая тонны зерна и заражая остатки своими экскрементами. Выжившие пытаются травить крыс, но те адаптируются к ядам и становятся только агрессивнее. Люди голодают, едят самих крыс, рискуя заразиться смертельными болезнями, и надеются, что нашествие закончится.",

    "Глобальная засуха в бассейнах великих рек Китая и Индии, где живут миллиарды людей, привела к нехватке воды и гибели урожая. Реки пересохли, рисовые поля превратились в пустыню, начался голод, от которого умирают тысячи каждый день. Выжившие пытаются копать колодцы и собирать дождевую воду, но её слишком мало. Люди покидают родные места и уходят в горы, надеясь найти там воду и еду, но и там ресурсы на исходе.",

    "Разрушение нефтепроводов в Сибири из-за землетрясений привело к загрязнению огромных территорий и уничтожению тайги. Нефть отравила реки и почву, рыба и звери погибли, люди остались без еды и воды. Выжившим приходится покидать обжитые места и уходить на юг, где ещё можно найти чистую воду и дичь. Но на юге их никто не ждёт, начинаются конфликты с местными за ресурсы, и кровь льётся рекой.",

    "Глобальная эпидемия холеры, вызванная загрязнением водопроводной воды из-за ветхости инфраструктуры, убила миллионы людей. Люди пьют воду из-под крана и умирают в страшных мучениях за считанные часы, больницы переполнены. Выжившие кипятят воду и используют таблетки для обеззараживания, но их не хватает на всех. Вода стала главным врагом, люди боятся пить даже бутилированную, надеясь, что она не заражена.",

    "Катастрофическое нашествие колорадского жука, уничтожившего все посадки картофеля в Европе и Азии, лишило людей второго хлеба. Картошка, основа питания миллионов, исчезла с прилавков, цены на овощи взлетели до небес. Выжившие пытаются выращивать картофель в теплицах и на гидропонике, но жук находит новые способы проникновения. Люди едят коренья и капусту, но без картофеля рацион стал скудным и неполноценным, начались болезни от нехватки витаминов.",

    "Глобальное отравление рыбы ртутью из-за выбросов промышленности привело к тому, что морепродукты стали смертельно опасными. Рыбаки остались без работы, заводы по переработке рыбы закрылись, миллионы людей остались без источника белка. Выжившим приходится есть консервы, но их запасы тают, а новые произвести не из чего. Люди голодают, едят водоросли и медуз, надеясь, что они не отравлены, и умирают от голода и болезней.",

    "Разрушение плотин на Волге и Каме из-за ветхости и землетрясений привело к затоплению огромных территорий и уничтожению урожая. Вода смыла города и деревни, люди гибли тысячами, оставшиеся без крова бродят по руинам. Выжившим приходится спасаться на возвышенностях, где нет ни еды, ни воды, ни тепла. Начинается борьба за выживание, где сильные отнимают последнее у слабых, а помощи ждать неоткуда.",

    "Глобальная эпидемия бешенства среди диких животных привела к тому, что леса стали смертельно опасными для человека. Волки, лисы, еноты и даже белки набрасываются на людей, кусают и заражают смертельным вирусом. Выжившие боятся выходить за пределы городов, дичь стала недоступна, охота невозможна. Люди голодают, едят только то, что вырастили сами, но урожаи скудны, и голод косит население.",

    "Катастрофическое нашествие мышей, уничтоживших запасы зерна в амбарах и элеваторах по всей стране, оставило людей без хлеба. Грызуны размножаются с невероятной скоростью, пожирая тонны зерна и заражая остатки своими экскрементами. Выжившие пытаются травить мышей, но те адаптируются к ядам и становятся только агрессивнее. Люди голодают, едят самих мышей, рискуя заразиться смертельными болезнями, и надеются, что нашествие закончится.",

    "Глобальная засуха в бассейне Нила, от которого зависит пропитание сотен миллионов людей в Африке, привела к нехватке воды и гибели урожая. Река обмелела, поля превратились в пустыню, начался голод, от которого умирают тысячи каждый день. Выжившие пытаются копать колодцы и собирать дождевую воду, но её слишком мало. Люди покидают родные места и уходят на юг, надеясь найти там воду и еду, но и там ресурсы на исходе.",

    "Разрушение системы газоснабжения из-за серии взрывов на газопроводах оставило миллионы людей без тепла и возможности готовить еду. Зимой люди мёрзнут в собственных домах, сжигая мебель и книги, чтобы согреться, но запасы топлива тают. Выжившим приходится жечь всё, что горит, но дышать нечем, начинаются болезни лёгких и смерти от угарного газа. Люди покидают города и уходят в деревни, где можно топить печи дровами, но и там дров не хватает на всех.",

    "Глобальная эпидемия туберкулёза, устойчивого ко всем антибиотикам, поразила миллионы людей, превратив их в заразных ходячих мертвецов. Больницы переполнены, лекарства не помогают, люди умирают мучительной смертью, заражая окружающих. Выжившие боятся дышать одним воздухом с другими, носят респираторы и изолируются в герметичных убежищах. Общество раскололось на здоровых и больных, началась охота на заражённых, которых уничтожают без суда и следствия.",

    "Катастрофическое нашествие лугового мотылька, уничтожившего посевы кукурузы на всех континентах, лишило миллиарды людей основного корма для скота. Кукуруза, из которой делают корма для животных, исчезла, скот начал гибнуть от голода. Выжившим приходится забивать скот, пока он не умер, но мяса не хватит надолго. Люди едят конину и козлятину, но и она быстро заканчивается, начинается голод, от которого умирают тысячи.",

    "Глобальное отравление атмосферы выбросами вулканов, проснувшихся по всему тихоокеанскому огненному кольцу, сделало воздух ядовитым. Люди задыхаются на улицах, в домах приходится герметизировать окна и использовать фильтры, которых не хватает на всех. Выжившие не выходят наружу без противогазов, надеясь, что вулканы успокоятся, но извержения продолжаются годами. Запасы фильтров тают, люди задыхаются, надежды на спасение почти нет.",

    "Разрушение системы канализации в мегаполисах из-за ветхости и отсутствия ремонта привело к эпидемиям кишечных инфекций, убивающих миллионы. Нечистоты заливают улицы, заражая воду и почву, люди травятся водой из-под крана и умирают в страшных мучениях. Выжившим приходится кипятить воду и использовать хлорку, но её не хватает на всех. Города превратились в гигантские выгребные ямы, люди покидают их, спасаясь от вони и заразы.",

    "Глобальная эпидемия гриппа, мутировавшего и ставшего смертельным для молодых и здоровых, убила миллионы людей за несколько месяцев. Больницы переполнены, врачи сами умирают, некому хоронить умерших, трупы лежат на улицах. Выжившие боятся выходить из домов, носят маски и перчатки, но вирус проникает везде. Люди гибнут от пневмонии за считанные дни, и никто не знает, когда это закончится и закончится ли вообще.",

    "Катастрофическое нашествие садового долгоносика, уничтожившего все плодовые деревья в садах и питомниках, лишило людей фруктов и ягод. Яблоки, груши, сливы исчезли с прилавков, цены на витамины взлетели до небес. Выжившим приходится есть овощи и консервы, но без фруктов начались болезни от нехватки витаминов. Люди едят дикие ягоды, но их мало, и они часто ядовиты, умирая от отравлений.",

    "Глобальное нашествие комаров, переносящих малярию и лихорадку денге, сделало жизнь на открытом воздухе невозможной. Комаров так много, что они забивают нос и рот, люди задыхаются и сходят с ума от зуда и болезней. Выжившие прячутся в домах с москитными сетками и используют репелленты, но их запасы тают. Люди не могут работать в полях, урожаи гибнут, начинается голод, от которого умирают не меньше, чем от укусов.",

    "Разрушение системы железных дорог, по которым доставляется продовольствие в отдалённые регионы, привело к голоду в глубинке. Поезда не ходят, грузовики не могут проехать по разбитым дорогам, люди в деревнях и небольших городах остались без еды. Выжившим приходится самим выращивать овощи и охотиться, но без семян и инвентаря это почти невозможно. Люди едят кору и траву, надеясь, что помощь придёт, но помощи нет и не будет.",

    "Глобальное отравление почвы пестицидами, накопленными за десятилетия интенсивного сельского хозяйства, привело к тому, что почва стала бесплодной и непригодной для выращивания сельскохозяйственных культур. Всё, что вырастает, содержит яды, убивающие людей медленно, но верно. Выжившим приходится искать чистые уголки планеты, где почва ещё не отравлена, но их почти не осталось. Люди едят привозную еду, но её мало, и она дорога, начинается голод, от которого умирают миллионы."



  ],

  bunkers: [
    {
      "duration_years": 5,
      "food_years": 3,
      "extra": "Бетонные стены толщиной два метра, герметичные двери и автономная система жизнеобеспечения. Есть дизель-генератор и запас топлива, система фильтрации воздуха и артезианская скважина. Две двуспальные кровати, одна из которых сломана."
    },
    {
      "duration_years": 2,
      "food_years": 1.5,
      "extra": "Обычное советское бомбоубежище на 300 человек, построенное ещё в семидесятые. Вода в ржавых баках, вентиляция работает с перебоями, генератор сломан. Есть огромный склад инструментов и запчастей."
    },

    {
      "duration_years": 3,
      "food_years": 2,
      "extra": "Заброшенная метеорологическая станция, переоборудованная под убежище. Есть солнечные батареи и ветряк, отапливается геотермальным источником. Есть связь с другими станциями, но мало места и негерметична."
    },
    {
      "duration_years": 4,
      "food_years": 2.5,
      "extra": "Глубокий тоннель метро, отгороженный гермозатворами от остальной сети. Вода из протекающих грунтовых вод, огромные пространства, можно разбить огороды. Постоянная сырость и плесень."
    },
    {
      "duration_years": 3,
      "food_years": 4,
      "extra": "Бетонное зернохранилище, переделанное под жильё. Огромные запасы крупы, есть своя скважина. Холодный бетон, нет нормальной вентиляции и крыша протекает."
    },
    {
      "duration_years": 5,
      "food_years": 3,
      "extra": "Секретный военный объект, заброшенный в девяностых. Ржавые механизмы, проржавевшие трубы, но полный арсенал оружия и боеприпасов. Есть оружейный склад."
    },
    {
      "duration_years": 6,
      "food_years": 4,
      "extra": "Современный научный комплекс, построенный для изучения вечной мерзлоты. Есть лаборатория и медотсек, полная автономия, геотермальное отопление, но мало жилого пространства."
    },
    {
      "duration_years": 3,
      "food_years": 2,
      "extra": "Заброшенная подводная лаборатория, используемая как убежище. Есть опреснитель воды, полная изоляция от внешнего мира. Шум волн, постоянный риск разгерметизации."
    },
    {
      "duration_years": 6,
      "food_years": 4,
      "extra": "Старый бункер времен холодной войны, законсервированный и забытый. Толстенные стены, запасы сухого пайка, дизельный генератор. Проблемы с вентиляцией. Есть запертый сейф с запчастями инструментами"
    },
    {
      "duration_years": 4,
      "food_years": 3.5,
      "extra": "Подземный торговый центр, переоборудованный в убежище. Огромные площади, множество магазинов с товарами и генератор. Трудно охранять, много входов. Есть запертый сейф с оружием"
    },
    {
      "duration_years": 8,
      "food_years": 6,
      "extra": "Бункер правительственный класса 'А', построенный для высшего руководства. Полная автономия, связь со спутниками, медотсек, запасы топлива на годы. Очень тесно, мало места. Есть запертый сейф с информацией о соседних бункерах"
    },
    {
      "duration_years": 5,
      "food_years": 3,
      "extra": "Переоборудованный винный погреб старинного замка. Каменные стены, прохладно, есть небольшой запас еды и воды. Отличная акустика, но нет электричества и отопления. Есть запертый сейф с дробовиком и патронами"
    },
    {
      "duration_years": 3,
      "food_years": 2,
      "extra": "Шахта в горах, заброшенная и забытая. Глубоко под землёй, есть вода из подземных источников. Огромные пространства, но нет света и вентиляции."
    },
    {
      "duration_years": 4,
      "food_years": 3,
      "extra": "Бункер религиозной секты, построенный в ожидании конца света. Запасы еды на годы, есть грядка и скважина, не работает вентиляция."
    },
    {
      "duration_years": 6,
      "food_years": 5,
      "extra": "Подземный бункер олигарха, построенный по последнему слову техники. Полная автоматизация, системы очистки воды и воздуха, спутниковый интернет. Нет запасов топлива, всё на электричестве."
    },
    {
      "duration_years": 5,
      "food_years": 3,
      "extra": "Старое бомбоубежище при заводе, переделанное выживальщиками. Укреплено дополнительно, есть запасы оружия и инструментов. Сырость и плесень, проблемы с отоплением."
    },
    {
      "duration_years": 7,
      "food_years": 5,
      "extra": "Подземный исследовательский центр в Антарктиде. Полная автономия, геотермальное отопление, есть запертый сейф с едой на год"
    },
    {
      "duration_years": 4,
      "food_years": 3,
      "extra": "Заброшенная военная база на острове. Укреплённые сооружения, склады с оружием и боеприпасами, дизельный генератор. Проблемы с пресной водой, нужно собирать дождевую."
    },
    {
      "duration_years": 3,
      "food_years": 2,
      "extra": "Пещерный комплекс в скалах, оборудованный под жильё. Естественная защита от внешнего мира, есть вода из подземного озера. Сыро, холодно, нет электричества и отопления."
    },
    {
      "duration_years": 5,
      "food_years": 4,
      "extra": "Подземный бункер на территории бывшей военной части. Толстые стены, герметичные двери, запасы еды и воды. Есть дизельный генератор и запас топлива. Проблемы с вентиляцией."
    },
    {
      "duration_years": 6,
      "food_years": 4,
      "extra": "Убежище в заброшенной шахте по добыче урана. Глубоко под землёй, радиационный фон повышен, но терпимо. Есть вода и запасы еды, проблемы со свежим воздухом. Есть запертый сейф с 3 радиационно-защитными комплектами"
    },
    {
      "duration_years": 4,
      "food_years": 3,
      "extra": "Бункер в скале, вырубленный вручную группой выживальщиков. Уютно, тепло, есть запасы еды и воды. Очень мало места, тесно, но уютно."
    },
    {
      "duration_years": 3,
      "food_years": 2,
      "extra": "Подземный гараж, переоборудованный под убежище. Бетонные стены, есть запасы еды и воды. Холодно, сыро, проблемы с вентиляцией, рядом есть озеро с рыбой"
    },
    {
      "duration_years": 5,
      "food_years": 4,
      "extra": "Старый бункер времён Второй мировой войны, восстановленный энтузиастами. Толстые стены. Сыро, темно, но есть печное отопление (хватит на 4 года)."
    },
    {
      "duration_years": 4,
      "food_years": 3,
      "extra": "Подземный бункер на территории заброшенного санатория. Уютные комнаты, запасы еды. Не работает электричество."
    },
    {
      "duration_years": 6,
      "food_years": 5,
      "extra": "Бункер на территории бывшей ракетной шахты. Глубоко под землёй, полная автономия, запасы еды и воды на годы. Нет отопления."
    },
    {
      "duration_years": 3,
      "food_years": 2,
      "extra": "Пещера в горах, оборудованная под жильё альпинистами. Есть печь, но нет дров. Имеется 2 комплекта альпинистского снаряжения. Неподалеку ручей."
    },
    {
      "duration_years": 5,
      "food_years": 4,
      "extra": "Подземный бункер на территории заброшенной турбазы. Проблемы с электричеством, есть печное отопление и баня. Вокруг лес."
    },

    {
      "duration_years": 4,
      "food_years": 2,
      "extra": "Старый бункер на вершине холма, переоборудованный под жильё. Толстые бетонные стены, есть радарная установка, позволяющая отслеживать движение на поверхности. Запасов еды мало, но есть дизельный генератор и запас топлива."
    },
    {
      "duration_years": 5,
      "food_years": 3,
      "extra": "Подземный командный центр военной базы, законсервированный после холодной войны. Многоуровневые помещения, система автономного жизнеобеспечения, запасы сухого пайка и воды. Есть связь со спутниками, но оборудование устарело и работает с перебоями."
    },
    {
      "duration_years": 3,
      "food_years": 2,
      "extra": "Переоборудованный овощехранилище, спрятанное под землёй. Огромные площади, ровный климат круглый год, есть своя скважина и система вентиляции. Запасов еды мало, но можно выращивать овощи на гидропонике."
    },
    {
      "duration_years": 6,
      "food_years": 4,
      "extra": "Бункер банка, предназначенный для хранения ценностей и сотрудников. Толстенные стены, герметичные двери, автономная система жизнеобеспечения. Есть запас еды и воды, но очень мало места и душно. Есть закрытый сейф с оружием."
    },
    {
      "duration_years": 4,
      "food_years": 3,
      "extra": "Старое бомбоубежище при университете, переоборудованное студентами-выживальщиками. Креативные решения, самодельные системы очистки воды, библиотека учебников и инструкций. Запасов еды мало, но есть генератор и топливо."
    },
    {
      "duration_years": 7,
      "food_years": 5,
      "extra": "Подземный бункер на территории психиатрической больницы. Толстые стены, изолированные палаты, система принудительной вентиляции. Есть запасы медикаментов и инструментов, но атмосфера тяжёлая и давящая. "
    },
    {
      "duration_years": 7,
      "food_years": 5,
      "extra": "Убежище в соляной шахте, глубоко под землёй. Стабильная температура, чистый воздух, огромные пространства. Есть вода из подземных источников, запасы еды. Проблемы с освещением и вентиляцией."
    },
    {
      "duration_years": 4,
      "food_years": 4,
      "extra": "Переоборудованный бункер для хранения ядерных отходов. Толстые свинцовые стены, система фильтрации воздуха, герметичные двери. Радиационный фон повышен, но терпим."
    },
    {
      "duration_years": 3,
      "food_years": 2,
      "extra": "Подземный бункер на территории старого кладбища. Мрачная атмосфера, постоянный страх и напряжение. Есть вода из скважины, запасы еды, генератор и топливо. Психологическое давление очень сильное. Есть закрытый сейф с теплой одеждой."
    },
    {
      "duration_years": 5,
      "food_years": 3,
      "extra": "Бункер охотников в лесу. Маскировка отличная, рядом есть озеро с рыбой и дичь в лесу. Запасов еды мало, но есть инструменты для охоты. Не работает отопление."
    },
    {
      "duration_years": 4,
      "food_years": 3,
      "extra": "Подземный бункер при нефтеперерабатывающем заводе. Толстые стены, запасы топлива на годы, система отопления и вентиляции. Не работает канализация. Есть закрытый сейф с картой местности (можно узнать об озере с рыбой недалеко от бункера)."
    },
    {
      "duration_years": 6,
      "food_years": 5,
      "extra": "Бункер правительственной связи, глубоко под землёй. Полная автономия, спутниковая связь, системы очистки воздуха и воды. Запасов еды на годы, но очень тесно и душно."
    },
    {
      "duration_years": 5,
      "food_years": 4,
      "extra": "Убежище в пещере, оборудованное спелеологами. Естественная защита, подземное озеро с чистой водой, стабильная температура. Проблемы с освещением и вентиляцией."
    },
    {
      "duration_years": 3,
      "food_years": 2,
      "extra": "Переоборудованный подземный гараж жилого дома. Есть генератор и топливо, но шумно и сыро. Постоянная угроза обрушения, требуется ремонт. Есть закрытый сейф с инструментами и запчастями."
    },
    {
      "duration_years": 4,
      "food_years": 3,
      "extra": "Старый бункер на территории военного полигона. Толстые стены, система вентиляции и фильтрации повреждена. Рядом есть склад боеприпасов и оружия."
    },
    {
      "duration_years": 7,
      "food_years": 6,
      "extra": "Подземный бункер на острове в океане. Полная изоляция, геотермальное отопление, опреснитель воды. Постоянная угроза цунами и ураганов."
    },
    {
      "duration_years": 5,
      "food_years": 4,
      "extra": "Бункер в скале над морем, вырубленный вручную. Фантастический вид, свежий воздух, вода из ручья. Запасов еды мало, можно рыбачить. Проблемы с отоплением и защитой от ветра."
    },
    {
      "duration_years": 4,
      "food_years": 3,
      "extra": "Подземный бункер на территории завода по переработке мусора. Толстые стены, запасы топлива, система отопления. Вонь и грязь, но можно найти полезные вещи на свалке. Запасов еды достаточно."
    },
    {
      "duration_years": 3,
      "food_years": 2,
      "extra": "Переоборудованный подвал старой церкви. Каменные стены, есть вода из колодца, запасы еды. Генератора нет, освещение свечами. Атмосфера умиротворяющая, но холодно и сыро."
    },
    {
      "duration_years": 6,
      "food_years": 5,
      "extra": "Бункер на территории секретной лаборатории. Полная автономия, системы очистки, запасы еды и воды на годы. Есть лаборатория и медотсек, но постоянный риск утечки опасных веществ."
    },
    {
      "duration_years": 5,
      "food_years": 4,
      "extra": "Убежище в заброшенном бункере под стадионом. Огромные пространства, есть вода из технических труб, запасы еды. Генератор и топливо есть, проблемы с вентиляцией и сыростью."
    },
    {
      "duration_years": 4,
      "food_years": 3,
      "extra": "Подземный бункер на территории фермы. Толстые стены, есть вода из скважины, запасы еды. Рядом поля, где можно выращивать овощи. Есть скот и птица, но их нужно кормить."
    },
    {
      "duration_years": 3,
      "food_years": 2,
      "extra": "Переоборудованный подземный переход под площадью. Бетонные стены, есть вода из технических труб, запасы еды. Холодно, сыро, постоянный шум с поверхности. Генератора нет."
    },
    {
      "duration_years": 5,
      "food_years": 4,
      "extra": "Старый бункер на территории тюрьмы. Толстые стены, решётки, охраняемая территория. Атмосфера гнетущая, постоянное напоминание о заключении."
    },
    {
      "duration_years": 4,
      "food_years": 3,
      "extra": "Бункер выживальщиков в лесу. Маскировка, автономное отопление. Есть генератор и топливо. Уютно, но тесно."
    },
    {
      "duration_years": 6,
      "food_years": 5,
      "extra": "Подземный бункер на территории аэропорта. Толстые стены, запасы топлива, системы очистки. Есть связь с диспетчерской, можно принимать сообщения. Запасов еды достаточно. Неподалеку океан."
    },
    {
      "duration_years": 5,
      "food_years": 4,
      "extra": "Убежище в бункере под зданием вокзала. Генератор и топливо есть, проблемы с вентиляцией и крысами."
    },
    {
      "duration_years": 4,
      "food_years": 3,
      "extra": "Переоборудованный подземный склад овощей. Холодно, но стабильная температура. Генератора нет, освещение свечами. Проблемы с вентиляцией."
    },
    {
      "duration_years": 3,
      "food_years": 2,
      "extra": "Бункер на территории стройки, вырытый экскаватором и укреплённый бетонными плитами. Имеется ящик инструментов, каска и стройматериалы. Холодно, сыро, постоянная угроза обрушения, требуется капитальный ремонт."
    },
    {
      "duration_years": 5,
      "food_years": 3.5,
      "extra": "Подземный бункер на территории НИИ. Толстые стены, системы очистки, лаборатории и мастерские. Есть генератор и топливо. Есть закрытый сейф с оружием. Не работает вентиляция"
    },
    {
      "duration_years": 8,
      "food_years": 10,
      "extra": "Огромные запасы консервов и круп, рассчитанные на десятилетие. Есть гидропонная установка для выращивания свежих овощей и зелени. Система вентиляции позволяет поддерживать оптимальную влажность для длительного хранения продуктов. Не работает канализация, имеется трещина в несущей стене, требуется ремонт"
    },
    {
      "duration_years": 4,
      "food_years": 5,
      "extra": "Подземное овощехранилище с огромными запасами картофеля, моркови и свёклы. Есть семенной фонд и теплицы с искусственным освещением. Система орошения работает от подземной скважины. Вентиляция не работает."
    },
    {
      "duration_years": 3,
      "food_years": 3,
      "extra": "Склад гуманитарной помощи с тоннами сухого молока, круп и консервов. Есть оборудование для выпечки хлеба и производства макарон. Запасов дрожжей и соли на годы вперёд. Отсутствует топливо для печи (уголь или дрова)"
    },


    {
      "duration_years": 3,
      "food_years": 2,
      "extra": "Подземный тир с большим запасом патронов и учебным оружием. Есть тренажёры и спортивный инвентарь. Вентиляция плохая, пахнет порохом."
    },
    {
      "duration_years": 2,
      "food_years": 0.5,
      "extra": "Бункер коллекционера марок и монет. Тысячи альбомов с марками, коллекционные монеты из разных стран. Еды почти нет, зато есть лупа и пинцеты."
    },
    {
      "duration_years": 5,
      "food_years": 3.5,
      "extra": "Подземная лаборатория по производству линз и очков. Есть станки для шлифовки, запасы оптического стекла и оправ. Можно делать очки для близоруких, лупы и микроскопы."
    },
    {
      "duration_years": 3,
      "food_years": 2,
      "extra": "Старый склад кожгалантереи с тысячами сумок, ремней и перчаток. Есть швейные машинки и нитки. Много кожи. Однако инструменты заперты в сейфе, код от которого неизвестен"
    },
    {
      "duration_years": 4,
      "food_years": 3,
      "extra": "Подземный цех по производству валенок и войлока. Запасы шерсти, войлока и инструментов. Тепло, уютно, но пахнет овчиной на весь бункер."
    },
    {
      "duration_years": 4,
      "food_years": 2,
      "extra": "Склад музыкальных инструментов с пианино, гитарами и барабанами. Есть нотная библиотека и усилители."
    },
    {
      "duration_years": 5,
      "food_years": 4,
      "extra": "Подземный гараж со старым грузовиком и запасами запчастей. Есть сварочный аппарат и баллоны с газом. Можно разобрать машины на металл. В 1 км от гаража есть лес."
    },
    {
      "duration_years": 4,
      "food_years": 3,
      "extra": "Склад старых матрасов и мебели. Много поролона, ткани и пружин. Можно сделать тёплые лежаки, но всё гнилое и пыльное, астматикам будет плохо."
    },
    {
      "duration_years": 4,
      "food_years": 3.5,
      "extra": "Заброшенный цех по переработке пуха и пера. В воздухе висит плотная взвесь из микрочастиц пуха, пыли и перьев, оседающая на лёгких при каждом вдохе. В бункере развелись клещи и моль. Вентиляция забита пухом и не работает, температура высокая, душно и влажно. Есть запасы крупы, но они кишат жучками и личинками моли."
    },
    {
      "duration_years": 4,
      "food_years": 5,
      "extra": "Подвал бывшей птицефабрики, где годами копился пух и перо. Пух летает в воздухе, оседает на одежде и еде, забивается в нос и горло. Вентиляция заблокирована пухом. Аллергики будут чихать не переставая. Есть запасы куриных тушек в морозильных камерах и яйца в холодильниках, правда, электричество отключается каждые несколько часов, требуется ремонт."
    },

  ],

  characteristics: {
    genders: ['Мужской', 'Женский'],


    bodyTypes: ['Легкое', 'Атлетичное', 'Полное', 'Сильное ожирение'],


    traits: [
      // ПОЛОЖИТЕЛЬНЫЕ (30)
      'Храбрый',
      'Добрый',
      'Щедрый',
      'Честный',
      'Общительный',
      'Оптимистичный',
      'Верный',
      'Надёжный',
      'Ответственный',
      'Трудолюбивый',
      'Терпеливый',
      'Милосердный',
      'Сострадательный',
      'Заботливый',
      'Внимательный',
      'Аккуратный',
      'Пунктуальный',
      'Целеустремлённый',
      'Находчивый',
      'Изобретательный',
      'Сообразительный',
      'Мудрый',
      'Рассудительный',
      'Спокойный',
      'Уравновешенный',
      'Весёлый',
      'Остроумный',
      'Дружелюбный',
      'Гостеприимный',
      'Миролюбивый',

      // НЕГАТИВНЫЕ (30)
      'Трусливый',
      'Злой',
      'Жадный',
      'Лживый',
      'Замкнутый',
      'Пессимистичный',
      'Эгоистичный',
      'Наглый',
      'Хитрый',
      'Коварный',
      'Мстительный',
      'Жестокий',
      'Безжалостный',
      'Равнодушный',
      'Ленивый',
      'Неряшливый',
      'Безответственный',
      'Ветреный',
      'Непостоянный',
      'Капризный',
      'Вспыльчивый',
      'Агрессивный',
      'Грубый',
      'Высокомерный',
      'Тщеславный',
      'Надменный',
      'Подозрительный',
      'Мнительный',
      'Истеричный',
      'Мазохист',

      // НЕЙТРАЛЬНЫЕ (20)
      'Молчаливый',
      'Разговорчивый',
      'Сдержанный',
      'Эмоциональный',
      'Рациональный',
      'Импульсивный',
      'Осторожный',
      'Рискованный',
      'Консервативный',
      'Прогрессивный',
      'Практичный',
      'Мечтательный',
      'Романтичный',
      'Циничный',
      'Сентиментальный',
      'Прагматичный',
      'Авантюрный',
      'Домосед',
      'Путешественник',
      'Одиночка',

      // СПЕЦИФИЧЕСКИЕ (20)
      'Манипулятор',
      'Интриган',
      'Подхалим',
      'Ябеда',
      'Сплетник',
      'Зануда',
      'Педант',
      'Перфекционист',
      'Карьерист',
      'Трудоголик',
      'Фанатик',
      'Идеалист',
      'Реалист',
      'Фаталист',
      'Скептик',
      'Доверчивый',
      'Наивный',
      'Параноик',
      'Душнила',
      'Нарцисс'
    ],


    hobbies: [
      // АКТИВНЫЕ НА УЛИЦЕ (20)
      'Рыбалка',
      'Охота',
      'Спорт',
      'Туризм',
      'Альпинизм',
      'Скалолазание',
      'Бег',
      'Велоспорт',
      'Плавание',
      'Гребля',
      'Пешие прогулки',
      'Ориентирование',
      'Геокешинг',
      'Парашютный спорт',
      'Дайвинг',
      'Серфинг',
      'Лыжи',
      'Сноуборд',
      'Коньки',
      'Ролики',

      // СПОРТИВНЫЕ ИГРЫ (15)
      'Футбол',
      'Баскетбол',
      'Волейбол',
      'Теннис',
      'Настольный теннис',
      'Бадминтон',
      'Гольф',
      'Боулинг',
      'Бильярд',
      'Шахматы',
      'Шашки',
      'Нарды',
      'Покер',
      'Домино',
      'Карточные игры',

      // ТВОРЧЕСКИЕ (15)
      'Рисование',
      'Музыка',
      'Пение',
      'Игра на гитаре',
      'Игра на пианино',
      'Игра на барабанах',
      'Танцы',
      'Фотография',
      'Видеосъёмка',
      'Лепка',
      'Резьба по дереву',
      'Выжигание',
      'Гончарное дело',
      'Кузнечное дело',
      'Ювелирное дело',

      // РУКОДЕЛИЕ (10)
      'Вязание',
      'Вышивание',
      'Шитьё',
      'Плетение',
      'Макраме',
      'Бисероплетение',
      'Квиллинг',
      'Оригами',
      'Мыловарение',
      'Свечеварение',

      // КУЛИНАРНЫЕ (10)
      'Кулинария',
      'Выпечка',
      'Кондитерское дело',
      'Приготовление пиццы',
      'Приготовление суши',
      'Домашнее консервирование',
      'Виноделие',
      'Пивоварение',
      'Сыроделие',
      'Копчение',

      // ИНТЕЛЛЕКТУАЛЬНЫЕ (10)
      'Чтение',
      'Писательство',
      'Поэзия',
      'Изучение языков',
      'Астрономия',
      'История',
      'Археология',
      'Коллекционирование',
      'Разгадывание кроссвордов',
      'Головоломки',

      // ТЕХНИЧЕСКИЕ (8)
      'Ремонт техники',
      'Радиолюбительство',
      'Программирование',
      'Робототехника',
      'Моделирование',
      'Конструирование',
      'Сборка пазлов',
      '3D-печать',

      // ДОМАШНИЕ (6)
      'Садоводство',
      'Огородничество',
      'Цветоводство',
      'Разведение растений',
      'Домашние животные',
      'Аквариумистика',

      // ЭКСТРЕМАЛЬНЫЕ (6)
      'Страйкбол',
      'Пейнтбол',
      'Лазертаг',
      'Ножи метать',
      'Стрельба из лука',
      'Стендовая стрельба',

      // ПОШЛЫЕ/ИНТИМНЫЕ (10)
      'БДСМ-практики',
      'Свингер-вечеринки',
      'Ролевые игры в постели',
      'Стриптиз',
      'Эротические танцы',
      'Коллекционирование эротических журналов',
      'Коллекционирование нижнего белья',
      'Коллекционирование интимных игрушек',
      'Коллекционирование наручников',
      'Коллекционирование плёток',
      'Коллекционирование масок',
      'Посещение массажных салонов',


      // ДОПОЛНИТЕЛЬНЫЕ (10)
      'Медитация',
      'Йога',
      'Фитнес',
      'Боевые искусства',
      'Рыцарские турниры',
      'Историческая реконструкция',
      'Косплей',
      'Стендап',
      'Караоке',
      'Настольные игры'
    ],




    health: [
      // Общие (для терапевта)
      { name: 'Здоров' },
      { name: 'Анемия' },
      { name: 'Авитаминоз' },

      // Кардиолог (сердечно-сосудистые)
      { name: 'Гипертония' },
      { name: 'Гипотония' },
      { name: 'Аритмия' },
      { name: 'Тахикардия' },
      { name: 'Брадикардия' },
      { name: 'Ишемия' },
      { name: 'Стенокардия' },
      { name: 'Инфаркт' },
      { name: 'Инсульт' },
      { name: 'Атеросклероз' },
      { name: 'Варикоз' },
      { name: 'Тромбоз' },
      { name: 'Порок сердца' },
      { name: 'Кардиомиопатия' },

      // Онколог (онкология)
      { name: 'Онкология' },
      { name: 'Рак легких' },
      { name: 'Рак желудка' },
      { name: 'Рак печени' },
      { name: 'Рак поджелудочной' },
      { name: 'Рак кишечника' },
      { name: 'Рак молочной железы' },
      { name: 'Рак простаты' },
      { name: 'Лейкоз' },
      { name: 'Лимфома' },
      { name: 'Меланома' },
      { name: 'Саркома' },
      { name: 'Глиобластома' },


      // Невролог (неврологические)
      { name: 'Эпилепсия' },
      { name: 'Мигрень' },
      { name: 'Невралгия' },
      { name: 'Неврит' },
      { name: 'Радикулит' },
      { name: 'Остеохондроз' },
      { name: 'Грыжа' },
      { name: 'Паркинсон' },
      { name: 'Рассеянный склероз' },
      { name: 'Болезнь Альцгеймера' },
      { name: 'Менингит' },
      { name: 'Энцефалит' },
      { name: 'Невропатия' },
      { name: 'Синдром Туретта' },

      // Эпидемиолог/Инфекционист/Вирусолог (инфекционные)
      { name: 'Туберкулез' },
      { name: 'Гепатит A' },
      { name: 'Гепатит B' },
      { name: 'Гепатит C' },
      { name: 'ВИЧ' },
      { name: 'СПИД' },
      { name: 'Пневмония' },
      { name: 'Бронхит' },
      { name: 'Ангина' },
      { name: 'Грипп' },
      { name: 'ОРВИ' },
      { name: 'Корь' },
      { name: 'Краснуха' },
      { name: 'Ветрянка' },
      { name: 'Свинка' },
      { name: 'Коклюш' },
      { name: 'Дифтерия' },
      { name: 'Скарлатина' },
      { name: 'Малярия' },
      { name: 'Тиф' },
      { name: 'Холера' },
      { name: 'Чума' },
      { name: 'Сибирская язва' },
      { name: 'Бешенство' },
      { name: 'Столбняк' },
      { name: 'Ботулизм' },
      { name: 'Сальмонеллез' },
      { name: 'Дизентерия' },
      { name: 'Глисты' },
      { name: 'Аскаридоз' },

      // Иммунолог (аутоиммунные и аллергии)
      { name: 'Аллергия' },
      { name: 'Астма' },
      { name: 'Поллиноз' },
      { name: 'Крапивница' },
      { name: 'Отек Квинке' },
      { name: 'Анафилаксия' },
      { name: 'Экзема' },
      { name: 'Волчанка' },
      { name: 'Ревматоидный артрит' },
      { name: 'Склеродермия' },
      { name: 'Синдром Шегрена' },
      { name: 'Болезнь Крона' },
      { name: 'Язвенный колит' },

      // Дерматолог (кожные)
      { name: 'Псориаз' },
      { name: 'Дерматит' },
      { name: 'Нейродермит' },
      { name: 'Себорея' },
      { name: 'Акне' },
      { name: 'Фурункулез' },
      { name: 'Карбункул' },
      { name: 'Абсцесс' },
      { name: 'Флегмона' },
      { name: 'Рожа' },
      { name: 'Грибок' },
      { name: 'Лишай' },
      { name: 'Чесотка' },
      { name: 'Педикулез' },
      { name: 'Ожог' },
      { name: 'Обморожение' },

      // Травматолог (травмы)
      { name: 'Перелом' },
      { name: 'Вывих' },
      { name: 'Растяжение' },
      { name: 'Разрыв связок' },
      { name: 'Гематома' },
      { name: 'Рваная рана' },
      { name: 'Резаная рана' },
      { name: 'Колотая рана' },
      { name: 'Огнестрельное ранение' },
      { name: 'Сотрясение мозга' },
      { name: 'Черепно-мозговая травма' },
      { name: 'Повреждение мениска' },
      { name: 'Разрыв мышцы' },

      // Офтальмолог (глазные)
      { name: 'Катаракта' },
      { name: 'Глаукома' },
      { name: 'Конъюнктивит' },
      { name: 'Блефарит' },
      { name: 'Ячмень' },
      { name: 'Кератит' },
      { name: 'Близорукость' },
      { name: 'Дальнозоркость' },
      { name: 'Астигматизм' },
      { name: 'Косоглазие' },
      { name: 'Отслоение сетчатки' },

      // Гинеколог (половая сфера)
      { name: 'Эндометриоз' },
      { name: 'Миома матки' },
      { name: 'Киста яичника' },
      { name: 'Полип' },
      { name: 'Воспаление придатков' },
      { name: 'Молочница' },
      { name: 'Бактериальный вагиноз' },
      { name: 'Герпес генитальный' },
      { name: 'Папилломавирус' },
      { name: 'Бесплодие' },
      { name: 'Импотенция' },
      { name: 'Простатит' },
      { name: 'Аденома простаты' },
      { name: 'Орхит' },
      { name: 'Эпидидимит' },
      { name: 'Уретрит' },
      { name: 'Цистит' },
      { name: 'Пиелонефрит' },

      // Гастроэнтеролог (ЖКТ)
      { name: 'Гастрит' },
      { name: 'Язва' },
      { name: 'Гастродуоденит' },
      { name: 'Панкреатит' },
      { name: 'Холецистит' },
      { name: 'Желчекаменная болезнь' },
      { name: 'Колит' },
      { name: 'Энтерит' },
      { name: 'Дисбактериоз' },
      { name: 'Изжога' },
      { name: 'Рефлюкс' },
      { name: 'Запор' },
      { name: 'Диарея' },
      { name: 'Геморрой' },
      { name: 'Анальная трещина' },

      // Психиатр (психические)
      { name: 'Депрессия' },
      { name: 'Тревожность' },
      { name: 'Панические атаки' },
      { name: 'ПТСР' },
      { name: 'Шизофрения' },
      { name: 'Биполярное расстройство' },
      { name: 'Невроз' },
      { name: 'Истерия' },
      { name: 'Паранойя' },
      { name: 'Деменция' },
      { name: 'Галлюцинации' },
      { name: 'Бред' },
      { name: 'ОКР' },
      { name: 'Анорексия' },
      { name: 'Булимия' },
      { name: 'Бессонница' },
      { name: 'Лунатизм' },


      // ЛОР
      { name: 'Отит' },
      { name: 'Синусит' },
      { name: 'Гайморит' },
      { name: 'Фронтит' },
      { name: 'Ринит' },
      { name: 'Фарингит' },
      { name: 'Ларингит' },
      { name: 'Тонзиллит' },
      { name: 'Аденоиды' },
      { name: 'Тугоухость' },
      { name: 'Глухота' },
      { name: 'Потеря голоса' },


      // Прочие
      { name: 'Радиационное поражение' },
      { name: 'Лучевая болезнь' },
      { name: 'Отравление' },
      { name: 'Интоксикация' },
      { name: 'Сепсис' },
      { name: 'Заражение крови' },
      { name: 'Гангрена' },
      { name: 'Некроз' },
      { name: 'Фимоз' },
      { name: 'Парафимоз' },
      { name: 'Водянка' },
      { name: 'Асцит' },
      { name: 'Подагра' },
      { name: 'Ревматизм' }
    ],
    inventory: [
      // Медицинские предметы (15)
      'Аптечка (полный набор медикаментов)',
      'Бинты (5 рулонов)',
      'Антисептик (1 литр)',
      'Обезболивающее (20 таблеток)',
      'Антибиотики (курс на 1 человека)',
      'Жгут кровоостанавливающий',
      'Шприцы (10 шт)',
      'Марля (10 рулонов)',
      'Пластырь (5 упаковок)',
      'Шины для переломов',

      // Инструменты (15)
      'Нож охотничий',
      'Топор',
      'Бензопила',
      'Молоток плотницкий',
      'Отвертка с набором бит',
      'Плоскогубцы универсальные',
      'Пила двуручная',
      'Лом-монтировка',
      'Веревка капроновая (50 м)',
      'Скотч армированный (5 рулонов)',
      'Изолента (5 рулонов)',
      'Проволока стальная (10 м)',


      // Освещение и огонь (8)
      'Фонарик светодиодный',
      'Спички (20 коробков)',
      'Зажигалка (5 шт)',
      'Свечи парафиновые (30 шт)',
      'Керосиновая лампа + 2 л керосина',
      'Батарейки (50 шт АА)',

      // Выживание и туризм (12)
      'Компас жидкостный',
      'Спальник зимний (-30°C)',
      'Коврик туристический',
      'Термос 2-литровый',
      'Фляга армейская 1 л',
      'Кофр водонепроницаемый',
      'Рюкзак тактический 80л',
      'Дождевик (5 шт)',
      'Сигнальные ракеты (10 шт)',
      'Свисток ультразвуковой',
      'Солнцезащитные очки',

      // Оружие и самооборона (10)
      'Охотничье ружье (12 калибр)',
      'Патроны (50 шт 12 калибр)',
      'Пистолет травматический',
      'Арбалет охотничий',
      'Стрелы для арбалета (20 шт)',
      'Электрошокер',
      'Газовый баллончик (3 шт)',
      'Кастет латунный',
      'Дубинка резиновая',
      'Мачете',

      // ЕДА (30)
      'Ящик тушенки (+3 мес.)',
      'Ящик мясных консервов (+3 мес.)',
      'Ящик рыбных консервов (+3 мес.)',
      'Ящик овощных консервов (+3 мес.)',
      'Ящик грибных консервов (+3 мес.)',
      'Большой ящик паштета (+6 мес.)',
      'Ящик армейских сухпайков (+6 мес.)',
      'Ящик галет (+3 мес.)',
      'Ящик крекеров (+3 мес.)',
      'Ящик гречки (+4 мес.)',
      'Ящик риса (+4 мес.)',
      'Ящик макарон (+4 мес.)',
      'Ящик овсянки (+4 мес.)',
      'Ящик перловки (+4 мес.)',
      'Ящик фасоли (+4 мес.)',
      'Ящик сухофруктов (+4 мес.)',
      'Ящик орехов (+4 мес.)',
      'Ящик семечек (+4 мес.)',
      'Ящик сухарей (+4 мес.)',
      'Ящик сока (+3 мес.)',
      'Ящик компота (+3 мес.)',
      'Ящик морса (+3 мес.)',
      'Ящик киселя (+3 мес.)',
      'Ящик с провизией (+6 мес.)',
      'Ящик с припасами (+6 мес.)',
      'Ящик с провиантом (+6 мес.)',


      'Семена картофеля',
      'Семена моркови',

      // ВОДА (3)
      'Канистра воды 20л (+0.5 мес.)',
      'Бутылки воды 30л (+1 мес.)',
      'Фильтр для воды (ресурс 1000 л)',

      // Одежда и защита (15)
      'Теплая куртка',
      'Валенки (пара)',
      'Шапка-ушанка меховая',
      'Перчатки зимние (2 пары)',
      'Термобелье (комплект)',
      'Резиновые сапоги (пара)',
      'Плащ-палатка армейская',
      'Защитный костюм ОЗК',
      'Противогаз с фильтрами (2 шт)',
      'Респиратор (4 шт)',
      'Дозиметр бытовой',
      'Шарф шерстяной',
      'Носки шерстяные (10 пар)',
      'Свитер вязаный',

      // Бытовая химия и гигиена (12)
      'Мыло хозяйственное (20 кусков)',
      'Шампунь (10 л)',
      'Зубная паста (20 тюбиков)',
      'Зубные щетки (5 шт)',
      'Туалетная бумага (50 рулонов)',
      'Чистящее средство (3 л)',
      'Перчатки резиновые (20 пар)',
      'Влажные салфетки (10 упаковок)',
      'Средства гигиены (набор)',


      // Пошлые предметы (15)
      'Эротические "Playboy" (20 шт)',
      'Наручники (2 пары)',
      'Плетка (кожаная)',
      'Резиновая женщина (надувная)',
      'Смазка (1 л)',
      'Презервативы (100 шт)',
      'Эротическое белье',
      'Кляп',
      'DVD с фильмами для взрослых (10 дисков)',
      'Виагра (упаковка 30 таблеток)',
      'БДСМ-набор (наручники, плетка, свечи)',

      // Книги и знания (8)
      'Медицинский справочник (1000 болезней)',
      'Атлас съедобных растений',
      'Карта местности (подробная)',
      'Дневник выживальщика',
      'Инструкция по ремонту техники',
      'Кулинарная книга (+2 мес. к запасам еды, +5 лет к стажу повара, если есть)',

      // Разное (10)
      'Рация (10 км)',
      'Бинокль (увеличение 20x)',
      'Нитки с иголкой (20 катушек)',
      'Код от сейфа (открывает любой сейф)',
      'Солнечная батарея портативная',


      // Самодельное и крафтовое (10)
      'Самодельный нож (из напильника)',
      'Копье с наконечником',
      'Лук самодельный (40 lb)',
      'Стрелы самодельные (20 шт)',
      'Капкан на зверя (3 шт)',
      'Удочка самодельная',
      'Удочка механическая',


      // Ценности и валюта
      'Сигареты (50 пачек)',
      'Алкоголь (5 бутылок)',

      // Дополнительные предметы 
      'Канистра с бензином (20 л)',
      'Генератор бензиновый (2 кВт)',
      'Солнечная батарея стационарная',
      'Плеер MP3 с радио',
      'Бинт эластичный (5 шт)',
      'Грелка резиновая',
      'Ледоруб',
      'ноутбук',
      'Трос стальной (10 м)',


      //для обогрева
      'Электрический обогреватель',
      'Тяжелое одеяло',
      'Набор тёплой одежды (2 шт.)',
      'Спальник',
      'Термобельё',
      'Валенки',
      'Термос',
      'Дрова',
      'Уголь',
      'Спички',
      'Зажигалка',

    ],



    phobias: [
      // Фобии, связанные с животными (10)
      'Арахнофобия (боязнь пауков)',
      'Кинофобия (боязнь собак)',
      'Айлурофобия (боязнь кошек)',
      'Офидиофобия (боязнь змей)',
      'Мусофобия (боязнь мышей)',
      'Энтомофобия (боязнь насекомых)',
      'Апифобия (боязнь пчел)',
      'Орнитофобия (боязнь птиц)',


      // Фобии, связанные с природой и стихиями (10)
      'Акрофобия (боязнь высоты)',
      'Клаустрофобия (боязнь замкнутых пространств)',
      'Агорафобия (боязнь открытых пространств)',
      'Бронтофобия (боязнь грома)',
      'Астрапофобия (боязнь молний)',
      'Гидрофобия (боязнь воды)',
      'Пирафобия (боязнь огня)',
      'Никтофобия (боязнь темноты)',
      'Анемофобия (боязнь ветра)',
      'Криофобия (боязнь холода)',

      // Фобии, связанные с людьми и социумом (12)
      'Антропофобия (боязнь людей)',
      'Демофобия (боязнь толпы)',
      'Социофобия (боязнь общества)',
      'Аутофобия (боязнь одиночества)',
      'Катагелофобия (боязнь насмешек)',
      'Скоптофобия (боязнь пристального взгляда)',
      'Эрейтофобия (боязнь покраснеть)',
      'Геронтофобия (боязнь стариков)',
      'Педиофобия (боязнь детей)',
      'Ксенофобия (боязнь чужаков)',
      'Фобофобия (боязнь страха)',
      'Энозофобия (боязнь осуждения)',

      // Фобии, связанные с болезнями и медициной (12)
      'Нозокомефобия (боязнь больниц)',
      'Ятрофобия (боязнь врачей)',
      'Гематофобия (боязнь крови)',
      'Травматофобия (боязнь травм)',
      'Алгофобия (боязнь боли)',
      'Кардиофобия (боязнь сердечного приступа)',
      'Канцерофобия (боязнь рака)',
      'Мизофобия (боязнь грязи)',
      'Гермофобия (боязнь микробов)',
      'Нозофобия (боязнь заболеть)',
      'Фармакофобия (боязнь лекарств)',
      'Токсофобия (боязнь отравления)',

      // Фобии, связанные с едой и телесными функциями (10)
      'Цибофобия (боязнь приготовленной пищи)',
      'Эметофобия (боязнь рвоты)',
      'Копрофобия (боязнь фекалий)',
      'Урофобия (боязнь мочи)',
      'Галофобия (боязнь говорить)',
      'Одинофагия (боязнь глотать)',
      'Пнигофобия (боязнь подавиться)',


      // Фобии, связанные с предметами и ситуациями (12)
      'Айхмофобия (боязнь острых предметов)',
      'Баллистофобия (боязнь оружия)',
      'Хоплофобия (боязнь огнестрельного оружия)',
      'Амаксофобия (боязнь автомобилей)',
      'Авиафобия (боязнь полетов)',
      'Клептофобия (боязнь воров)',
      'Охлофобия (боязнь толпы)',
      'Рипофобия (боязнь грязи)',
      'Папирофобия (боязнь бумаги)',
      'Гефирофобия (боязнь мостов)',
      'Крематофобия (боязнь денег)',

      // Фобии, связанные с психологическими состояниями (10)
      'Атаксиофобия (боязнь беспорядка)',
      'Децидофобия (боязнь принимать решения)',
      'Гипенгиофобия (боязнь ответственности)',
      'Кайрофобия (боязнь новых ситуаций)',
      'Метрофобия (боязнь поэзии)',
      'Гнозиофобия (боязнь знаний)',
      'Софиофобия (боязнь учиться)',
      'Эпистемофобия (боязнь знаний)',
      'Логофобия (боязнь слов)',
      'Ателофобия (боязнь несовершенства)',

      // Фобии, связанные с паранормальным (8)
      'Фазмофобия (боязнь призраков)',
      'Ликантропофобия (боязнь оборотней)',
      'Демонофобия (боязнь демонов)',
      'Гатофобия (боязнь ведьм)',
      'Психрофобия (боязнь холода)',
      'Небулофобия (боязнь тумана)',
      'Скелетофобия (боязнь скелетов)',
      'Тафофобия (боязнь быть похороненным заживо)',

      // СЕКСУАЛЬНЫЕ ФОБИИ (15)
      'Аграфобия (боязнь сексуальных домогательств)',
      'Контрелтофобия (боязнь стать жертвой домогательств)',
      'Агонофобия (боязнь быть изнасилованным)',
      'Генофобия (боязнь полового акта)',
      'Коитофобия (страх полового акта)',
      'Эротофобия (боязнь полового акта)',
      'Миксеофобия (боязнь обнажаться)',
      'Гимнофобия (боязнь наготы)',
      'Андрофобия (боязнь мужчин)',
      'Гинофобия (боязнь женщин)',
      'Гинекофобия (боязнь женщин)',
      'Гетерофобия (боязнь противоположного пола)',
      'Филофобия (боязнь влюбленности)',
      'Гамофобия (боязнь брака)',
      'Партенофобия (боязнь девственниц)',

      // ФОБИИ ПОЛОВЫХ ОРГАНОВ (8)
      'Итифаллофобия (боязнь эрегированного мужского органа)',
      'Фаллофобия (боязнь мужского полового органа)',
      'Вагинофобия (боязнь женских половых органов)',
      'Медомалакуфобия (боязнь потери эрекции)',
      'Онейрогмофобия (боязнь ночной эякуляции)',
      'Примейзодофобия (боязнь потерять девственность)',
      'Парафобия (боязнь собственных фетишей)',
      'Онанофобия (боязнь последствий мастурбации)',

      // ФОБИИ ПОСЛЕДСТВИЙ СЕКСА (7)
      'Гравидофобия (боязнь беременности)',
      'Токофобия (боязнь родов)',
      'Венерофобия (боязнь заразиться венерическими болезнями)',
      'Спидофобия (боязнь заразиться ВИЧ)',
      'Сифилософобия (боязнь заразиться сифилисом)',
      'Нозофобия (боязнь болезней)',
      'Аматофобия (боязнь пыли)',

      // ФОБИИ ИНТИМНОСТИ (8)
      'Гаптофобия (боязнь прикосновений)',
      'Филемафобия (боязнь поцелуев)',
      'Гаптефобия (боязнь касаний)',
      'Бромидрофобия (боязнь запаха тела)',
      'Осмофобия (боязнь запахов тела)',
      'Аутомизофобия (боязнь плохо пахнуть)',
      'Каунофобия (боязнь быть привлекательным)',
      'Калигинефобия (боязнь красивых женщин)',

      // ДОПОЛНИТЕЛЬНЫЕ ПОШЛЫЕ ФОБИИ (8)
      'Экзаудоризм (боязнь быть подслушанным в интимный момент)',
      'Анабозифобия (боязнь быть застигнутым в интимный момент)',
      'Фроттефобия (боязнь тереться о других в людных местах)',
      'Диспсихофобия (боязнь сойти с ума от желаний)',
      'Синтелофобия (боязнь обнажаться перед женщинами)',
      'Гимнофобия (боязнь раздеваться)',
      'Миксофобия (боязнь половых контактов из-за стыда)',

      // Пост-апокалиптические фобии (10)
      'Некрофобия (боязнь трупов)',
      'Танатофобия (боязнь смерти)',
      'Кенофобия (боязнь пустоты)',
      'Топофобия (боязнь определенных мест)',
      'Атазагорафобия (боязнь забыть важное)',
      'Дромофобия (боязнь переходить улицу)',
      'Эргофобия (боязнь работы)',
      'Сомнифобия (боязнь сна)',
      'Гипнофобия (боязнь заснуть)',
      'Эозофобия (боязнь рассвета)',

      // Дополнительные фобии (10)
      'Трихофобия (боязнь волос)',
      'Онихофобия (боязнь ногтей)',
      'Одонтофобия (боязнь зубов)',
      'Эйсоптрофобия (боязнь зеркал)',
      'Погонофобия (боязнь бороды)',
      'Аблютофобия (боязнь купания)',
      'Хроматофобия (боязнь цветов)',
      'Панфобия (боязнь всего)',
      'Уранофобия (боязнь рая)',
      'Стаурологическая фобия (боязнь распятия)',
      'Ригмофобия (боязнь трещин)',
      'Катагелиофобия (боязнь обрушения зданий)',
    ],


    extras: [
      // ПОЛОЖИТЕЛЬНЫЕ (45 шт - 30%)
      'Знание языков',
      'Навыки выживания',
      'Медицинское образование',
      'Педагогическое образование',
      'Инженерное образование',
      'Строительные навыки',
      'Кулинарные способности',
      'Слесарное дело',
      'Столярное мастерство',
      'Навыки охоты',
      'Умение рыбачить',
      'Навыки фермерства',
      'Знание растений',
      'Опыт военной службы',
      'Навыки рукопашного боя',
      'Умение обращаться с оружием',
      'Навыки маскировки',
      'Умение ориентироваться',
      'Знание карт',
      'Навыки альпинизма',
      'Навыки первой помощи',
      'Знание лекарственных трав',
      'Навыки психологической помощи',
      'Умение успокаивать людей',
      'Навыки ремонта техники',
      'Знание электрики',
      'Навыки сантехники',
      'Умение паять',
      'Знание металлов',
      'Умение точить инструменты',
      'Навыки выделки шкур',
      'Знание погоды',
      'Навыки радиосвязи',
      'Знание азбуки Морзе',
      'Умение вскрывать замки',
      'Навыки каллиграфии',
      'Знание астрономии',

      // НЕГАТИВНЫЕ/ПРЕСТУПНЫЕ (35 шт)
      'Судимость за кражу',
      'Судимость за грабеж',
      'Судимость за убийство',
      'Судимость за мошенничество',
      'Судимость за разбой',
      'Судимость за изнасилование',
      'Судимость за педофилию',
      'Судимость за контрабанду',
      'Судимость за браконьерство',
      'Член ОПГ',
      'Связи с криминалом',
      'Долги криминальным структурам',
      'Скрывается от правосудия',
      'Поддельные документы',
      'Угнал автомобиль',
      'Вымогал деньги',
      'Занимался проституцией',
      'Снимался в фильмах для взрослых',
      'Работал в эскорте',
      'Имеет венерическое заболевание',
      'Бил жену',
      'Бил детей',
      'Бросил семью',
      'Крал у сослуживцев',
      'Доносил на коллег',
      'Подставлял друзей',
      'Спал с чужой женой',
      'Спал с чужим мужем',
      'Изнасиловал в юности',
      'Насиловал животных',
      'Эксгибиционист',
      'Воровал женское белье',
      'Подглядывал за соседями',

      // ПОЗОРНЫЕ/СТЫДНЫЕ (35 шт)
      'Был уволен за пьянство',
      'Был уволен за кражу',
      'Был уволен за прогулы',
      'Нигде не работал',
      'Жил за счет родителей',
      'Жил за счет жены',
      'Бросил учебу',
      'Не умеет читать',
      'Не умеет писать',
      'Боится темноты',
      'Боится грозы',
      'Боится мышей',
      'Боится собак',
      'Боится вида крови',
      'Боится уколов',
      'Мочится в постель',
      'Храпит во сне',
      'Говорит во сне',
      'Ходит во сне',
      'Скрежещет зубами',
      'Грызет ногти',
      'Ковыряет в носу',
      'Пукает прилюдно',
      'Не моется',
      'Носит грязную одежду',
      'Ест насекомых',
      'Ковыряется в помойках',
      'Собирает мусор',
      'Суеверный',

      // ПОШЛЫЕ/ИНТИМНЫЕ (35 шт)
      'Коллекционирует порножурналы',
      'Порнозависимость',
      'Богатая интимная фантазия',
      'Любит БДСМ',
      'Любит ролевые игры',
      'Имеет интимные игрушки',
      'Посещал свингер-клубы',
      'Участвовал в оргиях',
      'Имел опыт групповых отношений',
      'Спал с начальником',
      'Спал с начальницей',
      'Изменял мужу',
      'Изменяла жене',
      'Имеет любовника',
      'Имеет любовницу',
      'Встречался с замужней',
      'Встречалась с женатым',
      'Имел интим с животным',
      'Имел опыт с трупом',
      'Интим с несовершеннолетними',
      'Интим с родственниками',
      'Интим с братом',
      'Интим с сестрой',
      'Интим с родителями',
      'Фут-фетишист',
      'БДСМ-мазохист',
      'БДСМ-садист',
      'Эксгибиционист',
      'Вуайерист',
      'Фроттерист',
      'Озабоченный',
      'Чайлдфри',


      // УСТРАШАЮЩИЕ (15 шт)
      'Каннибал',
      'Садист',
      'Психопат',
      'Социопат',
      'Некрофил',
      'Пироман',
      'Маньяк',
      'Серийный убийца',
      'Жестокий',
      'Вспыльчивый',
      'Ревнивый',
      'Нетрадиционной ориентации',
      'Нетрадиционной ориентации',
      'Нетрадиционной ориентации',
      'Сменил пол',
      'Сменил пол',
      'Любит фурри',
      'Квадробер',
      'Хоббихорсер',
      'Хоббимотокроссер',
      'Лысый',
      'Волосы по всему телу (синдром оборотня)',
      'Не моется',
    ],




    professions: [
      { name: 'Хирург', description: 'Может провести операцию и изменить степень болезни одному игроку' },
      { name: 'Анестезиолог', description: 'Может временно "усыпить" игрока — тот пропускает голосование текущего раунда' },
      { name: 'Терапевт', description: 'Может диагностировать здоровье любого игрока' },
      { name: 'Кардиолог', description: 'Может изменить степень сердечных заболеваний' },
      { name: 'Психиатр', description: 'Может 1 раз за игру раскрыть и 1 раз вылечить фобию выбранного игрока (2 разных действия)' },
      { name: 'Психолог', description: 'Может узнать черту характера выбранного игрока, а также раскрыть игрокам намерение киллера (если есть)' },
      { name: 'Эпидемиолог', description: 'Предотвращает распространение инфекционной  в бункере, может изменить степень инфекционных заболеваний' },
      { name: 'Вирусолог', description: 'Может разработать вакцину от неизвестного вируса, вызванного катастрофой или событием' },
      { name: 'Лор', description: 'Может изменить степень слуховых, носовых и горловых заболеваний' },
      { name: 'Иммунолог', description: 'Изменяет степень для иммунных заболеваний' },
      { name: 'Офтальмолог', description: 'Может изменить степень глазных заболеваний' },
      { name: 'Невролог', description: 'Может изменить степень неврологических заболеваний' },
      { name: 'Онколог', description: 'Может изменить степень онкологических заболеваний' },
      { name: 'Дерматолог', description: 'Может изменить степень кожных заболеваний' },
      { name: 'Диетолог', description: 'Уменьшает потребление еды в бункере, на количество месяцев, равному половине стажа' },
      { name: 'Инфекционист', description: 'Определяет источник заражения и блокирует его: может изменять степень инфекционных заболеваний и дезинфецировать предметы и еду' },
      { name: 'Гинеколог', description: 'Может изменить степень заболеваний половых органов, а также увеличивает успешность рождения здоровых детей' },
      { name: 'Сексолог', description: 'Выбирает двух разнополых игроков — между ними возникает скрытая симпатия. Они не могут голосовать друг против друга 1 раунд' },
      { name: 'Реаниматолог', description: 'Может один раз за игру вернуть к жизни недавно выбывшего игрока' },
      { name: 'Травматолог', description: 'Может изменить степень трамв и переломов' },
      { name: 'Массажист (эротический массаж)', description: 'Может расположить к себе одного игрока — тот не голосует против него 2 раунда' },
      { name: 'Эскорт-модель', description: 'Может выбрать одного игрока, который обязан поддержать её решение в раунде (в этом случае выбранный игрок не голосует, а голос игрока считается за два' },
      { name: 'Проститутка', description: 'Может соблазнить игрока — запретить ему голосовать против неё и убедить голосовать против выбранной цели в текущем раунде, если стаж 10 лет и более, то дополнительно 50% шанс заразить его ВИЧ (легкая степень)' },
      { name: 'Инженер-механик', description: 'Может починить сломанные устройства в бункере и предметы' },
      { name: 'Инженер-электрик', description: 'Может восстанавить электроснабжение' },
      { name: 'Коллектор', description: 'выбранный игрок обязан использовать способность по цели коллектора или раскрывает одну из своих скрытых характеристик по выбору коллектора' },
      { name: 'Спасатель', description: 'Может предотвратить последствия травм для 1 игрока при негативном событии' },
      { name: 'Следователь', description: 'Может разговорить любого игрока и узнать доп. сведения' },
      { name: 'Мафиози', description: 'Запрещает выбранному игроку применять свой навык в отношении одного из игроков до конца игры' },
      { name: 'Президент', description: 'Может сфальсифицировать результаты голосования в обратную сторону в 1 раунде (способность можно использовать как до, так и после голосования)' },
      { name: 'Социолог', description: 'Может предсказать исход голосования и изменить один голос' },
      { name: 'Метеоролог', description: 'Предсказывает опасные погодные события с шансом 80%, может выбрать безопасное время для вылазок из бункера' },
      { name: 'Депутат', description: 'Может уменьшить количество голосов против себя на 2' },
      { name: 'Лесник', description: 'Находит еду и ресурсы в окрестностях бункера, добавляет запас еды на 2 месяца + количество месяцев, равному половине стажа, если есть возможность совершать вылазки из бункера во время катастрофы' },
      { name: 'Охотник', description: 'Может добыть мясо для еды, если есть возможность совершать вылазки из бункера во время катастрофы, +3 месяца к запасам еды в бункере + количество месяцев, равному половине стажа, если есть возможность совершать вылазки из бункера во время катастрофы' },
      { name: 'Шеф-повар', description: 'Готовит из продуктов более сытную пищу, уменьшает потребление еды в бункере на количество месяцев, равному трети стажа' },
      { name: 'Строитель', description: 'Улучшает защиту и укрепления бункера, может починить сантехнику в бункере, а также может восстановить водоснабжение или канализацию' },
      { name: 'Онли-фанс модель', description: 'Отправляет свои фотки в соседний бункер, получая взамен еды на количество месяцев, равному четверти стажа' },
      { name: 'Фермер', description: 'Всегда носит с собой семена и инструменты, увеличивает запасы еды на количество месяцев, равному половине стажа, если в бункере есть условия для фермерства, то количество месяцев равно стажу' },
      { name: 'Астроном', description: 'Если получает негативные последствия в ходе события, то может их отменить 1 раз для себя, а также раскрыть игрокам намерение киллера (если есть)' },
      { name: 'Сплетник', description: 'Может подговорить голосовать против выбранного игрока 1 раз' },
      { name: 'Телохранитель', description: 'Умеет обращаться с оружием, может раскрыть намерение киллера (если есть), может защитить игрока от голосования 1 раз' },
      { name: 'Археолог', description: 'Может найти редкие ресурсы или полезные предметы для бункера, добавляет к себе в инвентарь коды и пароли от запертых предметов' },
      { name: 'Рыбак', description: 'Увеличивает запасы еды на количество месяцев равному стажу, если есть условия для рыбной ловли (водоемы + удочка/сетка + возможность вылазки из бункера)' },
      { name: 'Контрабандист', description: 'Может 1 раз за игру добавить себе в инвентарь ящик припасов (на 3 месяца) либо ящик оружия с патронами' },
      { name: 'Диверсант', description: 'Может вывести из строя одно устройство в бункере (например, вентиляцию, электроснабжение, канализацию)' },
      { name: 'Вор', description: 'Может украсть инвентарь у любого игрока, а также припасы на 3 месяца из чужого бункера, если о нем есть информация' },
      { name: 'Экстрасенс', description: 'Может узнать доп. сведения о любом игроке, а также раскрыть игрокам намерение киллера (если есть)' },
      { name: 'Таролог', description: 'Раскрывает черту характера или фобию выбранного игрока, а также раскрывает игрокам намерение киллера (если есть)' },
      { name: 'Тиктокер', description: 'Может «отвлечь» выбранного игрока, он не может голосовать и использовать способности 1 раунд' },
      { name: 'Киллер', description: 'Имеет при себе нож, пистолет и яд. Может незаметно убить одного игрока и никто об этом не узнает, только раскрывающие профессии могут отменить убийство' },
      { name: 'Боксер', description: 'Удар в подбородок и нокаут - выбранный игрок теряет возможность действовать в течение одного раунда (раскрывать характеристику можно, но молча)' },
      { name: 'Пчеловод', description: 'Собирает мёд и продукты пчеловодства, добавляет сладкие продукты на 3 месяца запаса еды' },
      { name: 'Двонрик', description: 'Во время уборки может найти полезный хлам, изменяет до 2 раз "рандомно" характеристику инвентарь' },
      { name: 'Картограф', description: 'Имеет при себе карту местности, может обнаружить водоем, плодородный участок для фермерства, а также соседние бункеры (если не противоречим условиям катострофы)' },
      { name: 'Профессор', description: 'Может увеличить стаж любому игроку: для возраста до 25 лет включительно - максимум на 1 год, от 26 до 49 - на 5 лет, от 50 - на 10 лет)' },
      { name: 'Учитель', description: 'Может рандомно изменить профессию любому игроку' },
      { name: 'Косметолог', description: 'Меняет внешность до неузнаваемости, может применить на себя или другого игрока "грим", остальные игроки обязаны верить, что возраст выбранного игрока на 10 лет меньше' },
      { name: 'Альпинист', description: 'Имеет при себе термобелье и горный комбинезон. Может безопасно передвигаться по снегу и льду, находить укрытия в горах, повышает безопасность вылазок в зимних катастрофах' },
      { name: 'Радиохимик', description: 'Может перерабатывать радиоактивные отходы в энергию для бункера, имеет защитный костюм от радиации' },
      { name: 'Программист', description: 'Может пробить игрока по базе данных и раскрыть возраст любого игроку, если стаж 10 лет и более, то сильно повышает шансы на выживание при восстании машин' },
      { name: 'Биолог', description: 'Может определить съедобность любых растений, умеет создавать лекарства, может очистить источник заражения в почве или водоеме' },
    ]
  }
};

// Степени тяжести для здоровья
const HEALTH_SEVERITIES = ['легкая', 'средняя', 'тяжелая', 'критическая'];

// ============ ФУНКЦИИ ДЛЯ ПАРСИНГА ЗДОРОВЬЯ ============
function parseHealthValue(healthString) {
  if (!healthString || healthString === 'Здоров') {
    return [];
  }

  // Разделяем по запятой и обрабатываем каждую часть
  const parts = healthString.split(',').map(s => s.trim());
  const diseases = [];

  for (const part of parts) {
    // Ищем формат "Болезнь (степень)"
    const match = part.match(/^(.+?)\s*\((\w+)\)$/);
    if (match) {
      diseases.push({
        name: match[1].trim(),
        severity: match[2]
      });
    } else {
      // Если нет скобок, добавляем с легкой степенью
      diseases.push({
        name: part,
        severity: 'легкая'
      });
    }
  }

  return diseases;
}

function formatHealthValue(diseases) {
  if (!diseases || diseases.length === 0) {
    return 'Здоров';
  }

  return diseases.map(d => `${d.name} (${d.severity})`).join(', ');
}
// ========================================================

// Функция генерации игрока
function generatePlayer(name, socketId) {
  const gender = GAME_DATA.characteristics.genders[Math.floor(Math.random() * GAME_DATA.characteristics.genders.length)];
  const age = Math.floor(Math.random() * (80 - 18 + 1)) + 18;
  const profession = GAME_DATA.characteristics.professions[Math.floor(Math.random() * GAME_DATA.characteristics.professions.length)];
  const experience = Math.floor(Math.random() * 30) + 1;

  const healthBase = GAME_DATA.characteristics.health[Math.floor(Math.random() * GAME_DATA.characteristics.health.length)];
  let healthValue = healthBase.name;

  if (healthBase.name !== 'Здоров') {
    const severity = HEALTH_SEVERITIES[Math.floor(Math.random() * HEALTH_SEVERITIES.length)];
    healthValue = `${healthBase.name} (${severity})`;
  }

  const player = {
    id: uuidv4(),
    socketId,
    name,
    characteristics: {
      gender: { value: `${gender} (${age} лет)`, revealed: false },
      bodyType: { value: GAME_DATA.characteristics.bodyTypes[Math.floor(Math.random() * GAME_DATA.characteristics.bodyTypes.length)], revealed: false },
      trait: { value: GAME_DATA.characteristics.traits[Math.floor(Math.random() * GAME_DATA.characteristics.traits.length)], revealed: false },
      profession: { value: `${profession.name} (стаж ${experience} лет)`, revealed: false },
      hobby: { value: GAME_DATA.characteristics.hobbies[Math.floor(Math.random() * GAME_DATA.characteristics.hobbies.length)], revealed: false },
      health: { value: healthValue, revealed: false },
      inventory: { value: GAME_DATA.characteristics.inventory[Math.floor(Math.random() * GAME_DATA.characteristics.inventory.length)], revealed: false },
      phobia: { value: GAME_DATA.characteristics.phobias[Math.floor(Math.random() * GAME_DATA.characteristics.phobias.length)], revealed: false },
      extra: { value: GAME_DATA.characteristics.extras[Math.floor(Math.random() * GAME_DATA.characteristics.extras.length)], revealed: false }
    }
  };

  playersDataMap.set(player.id, player);
  saveData();

  return player;
}

// ============ НОВЫЕ ФУНКЦИИ ДЛЯ ЗДОРОВЬЯ ============
function getRandomHealth() {
  const healthBase = GAME_DATA.characteristics.health[Math.floor(Math.random() * GAME_DATA.characteristics.health.length)];
  if (healthBase.name === 'Здоров') {
    return 'Здоров';
  }
  const severity = HEALTH_SEVERITIES[Math.floor(Math.random() * HEALTH_SEVERITIES.length)];
  return `${healthBase.name} (${severity})`;
}

function getRandomSeverity() {
  return HEALTH_SEVERITIES[Math.floor(Math.random() * HEALTH_SEVERITIES.length)];
}

function extractHealthName(healthString) {
  const match = healthString.match(/^([^(]+)/);
  return match ? match[1].trim() : healthString;
}
// ====================================================

// ============ НОВЫЕ ФУНКЦИИ ДЛЯ ХАРАКТЕРИСТИК ============
function getRandomValue(charKey, currentValue = null) {
  console.log(`getRandomValue called for ${charKey}, current: ${currentValue}`);

  // Маппинг ключей характеристик к правильным ключам в GAME_DATA
  const keyMapping = {
    'gender': 'genders',
    'bodyType': 'bodyTypes',
    'trait': 'traits',
    'hobby': 'hobbies',
    'phobia': 'phobias',
    'extra': 'extras',
    'profession': 'professions',
    'inventory': 'inventory',
    'health': 'health'
  };

  const dataKey = keyMapping[charKey] || charKey;
  const charData = GAME_DATA.characteristics[dataKey];

  if (!charData) {
    console.log(`No data for ${charKey} (looked for ${dataKey})`);
    return '—';
  }

  let newValue;
  const maxAttempts = 50;
  let attempts = 0;

  if (charKey === 'profession') {
    do {
      const prof = charData[Math.floor(Math.random() * charData.length)];
      const experience = Math.floor(Math.random() * 20) + 1;
      newValue = `${prof.name} (стаж ${experience} лет)`;
      attempts++;
    } while (newValue === currentValue && attempts < maxAttempts);
    return newValue;
  }

  if (charKey === 'gender') {
    do {
      const gender = charData[Math.floor(Math.random() * charData.length)];
      const age = Math.floor(Math.random() * (80 - 18 + 1)) + 18;
      newValue = `${gender} (${age} лет)`;
      attempts++;
      console.log(`Gender attempt ${attempts}: ${newValue}`);
    } while (newValue === currentValue && attempts < maxAttempts);
    return newValue;
  }

  // Для всех остальных характеристик
  do {
    newValue = charData[Math.floor(Math.random() * charData.length)];
    attempts++;
    console.log(`${charKey} attempt ${attempts}: ${newValue}`);
  } while (newValue === currentValue && attempts < maxAttempts);

  return newValue;
}

function parseCharacteristicValue(charKey, value) {
  console.log(`parseCharacteristicValue for ${charKey}: ${value}`);

  // Характеристики, которые не могут иметь несколько значений
  const singleValueKeys = ['profession', 'gender', 'health'];

  if (singleValueKeys.includes(charKey)) {
    return { main: value, items: [] };
  }

  if (value && value.includes(',')) {
    const items = value.split(',').map(s => s.trim());
    return { main: items[0], items: items.slice(1) };
  }

  return { main: value, items: [] };
}

function formatCharacteristicValue(charKey, mainValue, additionalItems = []) {
  console.log(`formatCharacteristicValue for ${charKey}: main=${mainValue}, additional=`, additionalItems);

  const singleValueKeys = ['profession', 'gender', 'health'];

  if (singleValueKeys.includes(charKey)) {
    return mainValue;
  }

  if (additionalItems.length > 0) {
    return [mainValue, ...additionalItems].join(', ');
  }

  return mainValue;
}
// =========================================================

// ================= ФУНКЦИИ ДЛЯ ГОЛОСОВАНИЯ =================
function startVoting(gameId, initiatorId) {
  const game = games.get(gameId);
  if (!game) return false;

  game.voting = {
    active: true,
    startTime: Date.now(),
    endTime: Date.now() + 15000,
    initiatorId: initiatorId,
    votes: {},
    voters: new Set(),
    timer: null
  };

  game.voting.timer = setTimeout(() => {
    endVoting(gameId);
  }, 15000);

  games.set(gameId, game);
  return true;
}

function endVoting(gameId) {
  const game = games.get(gameId);
  if (!game || !game.voting) return;

  if (game.voting.timer) {
    clearTimeout(game.voting.timer);
  }

  const results = {};
  const totalVotes = Object.keys(game.voting.votes).length;

  Object.values(game.voting.votes).forEach(votedForId => {
    results[votedForId] = (results[votedForId] || 0) + 1;
  });

  if (totalVotes > 0) {
    Object.keys(results).forEach(playerId => {
      results[playerId] = Math.round((results[playerId] / totalVotes) * 100);
    });
  }

  game.voting.active = false;
  game.voting.results = results;
  game.voting.totalVotes = totalVotes;

  games.set(gameId, game);

  io.to(gameId).emit('votingEnded', {
    results: results,
    totalVotes: totalVotes,
    votes: game.voting.votes
  });

  console.log(`Голосование в игре ${gameId} завершено`);
}

function cancelVoting(gameId) {
  const game = games.get(gameId);
  if (!game || !game.voting) return false;

  if (game.voting.timer) {
    clearTimeout(game.voting.timer);
  }

  delete game.voting;
  games.set(gameId, game);

  return true;
}




// ============ НАЧАЛО БЛОКА ГЕНЕРАЦИИ СОБЫТИЙ ============

// ============ РЕЕСТРЫ ДЛЯ СИСТЕМЫ СОБЫТИЙ ============
const ItemRegistry = {
  food: GAME_DATA.characteristics.inventory.filter(item => 
    item.includes('еды') || item.includes('консерв') || item.includes('тушенк') || item.includes('паек')),
  weapons: GAME_DATA.characteristics.inventory.filter(item => 
    item.includes('ружье') || item.includes('пистолет') || item.includes('нож') || item.includes('арбалет')),
  tools: GAME_DATA.characteristics.inventory.filter(item => 
    item.includes('топор') || item.includes('пила') || item.includes('молоток') || item.includes('инструмент')),
  medical: GAME_DATA.characteristics.inventory.filter(item => 
    item.includes('аптечк') || item.includes('бинт') || item.includes('антибиотик') || item.includes('шприц')),
  misc: GAME_DATA.characteristics.inventory.filter(item => 
    !item.includes('еды') && !item.includes('консерв') && !item.includes('ружье') && !item.includes('топор'))
};

const LocationRegistry = [
  'заброшенная больница', 'старая заправка', 'руины магазина', 'лесопосадка', 'овраг',
  'брошенный дом', 'подвал', 'чердак', 'железнодорожная станция', 'ферма',
  'овощехранилище', 'гараж', 'стройка', 'кладбище', 'школа', 'водонапорная башня'
];

const ThreatRegistry = [
  'бродячие собаки', 'мародеры', 'мутанты', 'бандиты', 'одичавшие псы',
  'крысы', 'кабаны', 'медведь', 'сектанты', 'радиация'
];

const InjuryRegistry = [
  'Перелом', 'Вывих', 'Растяжение', 'Рваная рана', 'Колотая рана', 'Сотрясение мозга',
  'Пневмония', 'Ангина', 'ОРВИ', 'Отравление', 'Ожог', 'Обморожение'
];
// =======================================================

// ============ ШАБЛОНЫ ФАКТОВ (НЕ ТЕКСТА!) ============
const EventTemplates = [
  {
    id: 'attack',
    requiredPlayers: 2,
    facts: [
      { type: 'threat', description: 'нападение' },
      { type: 'target', description: 'жертва' },
      { type: 'location', description: 'место' },
      { type: 'injury', description: 'травма' }
    ],
    possibleConsequences: (facts) => ([
      { type: 'add_disease', target: facts.target, value: facts.injury },
      { type: 'maybe_remove_item', target: facts.target, category: 'food', chance: 0.3 }
    ])
  },
  {
    id: 'find',
    requiredPlayers: 1,
    facts: [
      { type: 'hero', description: 'кто нашел' },
      { type: 'item', description: 'что нашел' },
      { type: 'location', description: 'где нашел' }
    ],
    possibleConsequences: (facts) => ([
      { type: 'add_item', target: facts.hero, value: facts.item }
    ])
  },
  {
    id: 'find_with_risk',
    requiredPlayers: 2,
    facts: [
      { type: 'hero', description: 'кто нашел' },
      { type: 'helper', description: 'помощник' },
      { type: 'item1', description: 'первая находка' },
      { type: 'item2', description: 'вторая находка' },
      { type: 'location', description: 'место' },
      { type: 'injury', description: 'травма' },
      { type: 'injured', description: 'пострадавший' }
    ],
    possibleConsequences: (facts) => ([
      { type: 'add_disease', target: facts.injured, value: facts.injury },
      { type: 'add_item', target: facts.hero, value: facts.item1 },
      { type: 'add_item', target: 'bunker', value: facts.item2 }
    ])
  },
  {
    id: 'break',
    requiredPlayers: 1,
    facts: [
      { type: 'hero', description: 'у кого сломалось' },
      { type: 'item', description: 'что сломалось' },
      { type: 'activity', description: 'причина' }
    ],
    possibleConsequences: (facts) => ([
      { type: 'remove_item', target: facts.hero, value: facts.item }
    ])
  },
  {
    id: 'accident',
    requiredPlayers: 1,
    facts: [
      { type: 'hero', description: 'пострадавший' },
      { type: 'location', description: 'место' },
      { type: 'injury', description: 'травма' }
    ],
    possibleConsequences: (facts) => ([
      { type: 'add_disease', target: facts.hero, value: facts.injury }
    ])
  },
  {
    id: 'theft',
    requiredPlayers: 1,
    facts: [
      { type: 'target', description: 'жертва' },
      { type: 'threat', description: 'вор' },
      { type: 'item', description: 'что украли' }
    ],
    possibleConsequences: (facts) => ([
      { type: 'remove_item', target: facts.target, value: facts.item }
    ])
  },
  {
    id: 'discover_cache',
    requiredPlayers: 1,
    facts: [
      { type: 'hero', description: 'кто нашел' },
      { type: 'location', description: 'место' },
      { type: 'item1', description: 'первая находка' },
      { type: 'item2', description: 'вторая находка' }
    ],
    possibleConsequences: (facts) => ([
      { type: 'add_item', target: facts.hero, value: facts.item1 },
      { type: 'add_item', target: 'bunker', value: facts.item2 }
    ])
  },
  {
    id: 'hunting',
    requiredPlayers: 1,
    facts: [
      { type: 'hero', description: 'охотник' },
      { type: 'animal', description: 'животное' },
      { type: 'item', description: 'добыча' },
      { type: 'injury', description: 'травма' }
    ],
    possibleConsequences: (facts) => ([
      { type: 'add_disease', target: facts.hero, value: facts.injury },
      { type: 'add_item', target: 'bunker', value: facts.item }
    ])
  }
];
// =======================================================

// ============ ФУНКЦИИ ДЛЯ РАБОТЫ С ФАКТАМИ ============
function getRandomItem(category = null) {
  if (category && ItemRegistry[category]) {
    const items = ItemRegistry[category];
    return items[Math.floor(Math.random() * items.length)];
  }
  
  const allItems = GAME_DATA.characteristics.inventory;
  return allItems[Math.floor(Math.random() * allItems.length)];
}

function getRandomPlayer(players, excludeIds = []) {
  const available = players.filter(p => 
    !p.status && !excludeIds.includes(p.id)
  );
  if (available.length === 0) return null;
  return available[Math.floor(Math.random() * available.length)];
}

function getRandomLocation() {
  return LocationRegistry[Math.floor(Math.random() * LocationRegistry.length)];
}

function getRandomThreat() {
  return ThreatRegistry[Math.floor(Math.random() * ThreatRegistry.length)];
}

function getRandomInjury() {
  return InjuryRegistry[Math.floor(Math.random() * InjuryRegistry.length)];
}

function getRandomAnimal() {
  const animals = ['кабан', 'олень', 'заяц', 'лось', 'косуля'];
  return animals[Math.floor(Math.random() * animals.length)];
}

function getRandomActivity() {
  const activities = ['рубки дров', 'ремонта', 'похода за водой', 'осмотра местности', 'рыбалки', 'охоты'];
  return activities[Math.floor(Math.random() * activities.length)];
}

function playerHasItem(player, itemName) {
  if (!player.characteristics.inventory.revealed) return false;
  const items = player.characteristics.inventory.value.split(',').map(i => i.trim());
  return items.some(i => i.includes(itemName));
}

function getRandomPlayerItem(player) {
  if (!player.characteristics.inventory.revealed) return null;
  const items = player.characteristics.inventory.value.split(',').map(i => i.trim());
  if (items.length === 0 || items[0] === '—') return null;
  return items[Math.floor(Math.random() * items.length)];
}
// =======================================================

// ============ ФУНКЦИЯ ГЕНЕРАЦИИ ФАКТОВ ============
function generateEventFacts(game) {
  const players = game.players.filter(p => !p.status);
  if (players.length === 0) return null;
  
  const maxAttempts = 30;
  
  for (let attempt = 0; attempt < maxAttempts; attempt++) {
    // Выбираем шаблон
    const template = EventTemplates[Math.floor(Math.random() * EventTemplates.length)];
    
    // Проверяем, достаточно ли игроков
    if (players.length < template.requiredPlayers) continue;
    
    const facts = { template: template.id };
    const usedPlayers = [];
    
    // Заполняем факты
    let valid = true;
    
    for (const fact of template.facts) {
      switch(fact.type) {
        case 'hero':
        case 'target':
        case 'injured':
          const player = getRandomPlayer(players, usedPlayers);
          if (!player) { valid = false; break; }
          facts[fact.type] = player;
          usedPlayers.push(player.id);
          break;
          
        case 'helper':
          const helper = getRandomPlayer(players, usedPlayers);
          if (!helper) { valid = false; break; }
          facts.helper = helper;
          usedPlayers.push(helper.id);
          break;
          
        case 'location':
          facts.location = getRandomLocation();
          break;
          
        case 'threat':
          facts.threat = getRandomThreat();
          break;
          
        case 'injury':
          facts.injury = getRandomInjury();
          break;
          
        case 'item':
        case 'item1':
        case 'item2':
          const item = getRandomItem();
          facts[fact.type] = item;
          break;
          
        case 'food':
          facts.food = getRandomItem('food');
          break;
          
        case 'weapon':
          facts.weapon = getRandomItem('weapons');
          break;
          
        case 'animal':
          facts.animal = getRandomAnimal();
          break;
          
        case 'activity':
          facts.activity = getRandomActivity();
          break;
      }
      
      if (!valid) break;
    }
    
    if (!valid) continue;
    
    // Валидация для событий с потерей предметов
    if (template.id === 'break' || template.id === 'theft') {
      const target = facts.target || facts.hero;
      if (!target.characteristics.inventory.revealed) continue;
      if (!playerHasItem(target, facts.item)) continue;
    }
    
    // Проверка на уникальность (против повторов)
    const hash = `${template.id}_${facts.hero?.id || facts.target?.id}`;
    const recentEvents = game.events || [];
    let isDuplicate = false;
    
    for (let i = 0; i < Math.min(5, recentEvents.length); i++) {
      if (recentEvents[i]?.facts?.hash === hash) {
        isDuplicate = true;
        break;
      }
    }
    
    if (isDuplicate) continue;
    
    // Добавляем хеш
    facts.hash = hash;
    
    return { template, facts };
  }
  
  return null;
}
// =======================================================

// ============ ФУНКЦИЯ ПРИМЕНЕНИЯ ПОСЛЕДСТВИЙ ============
function applyConsequencesFromFacts(game, facts, consequences) {
  const results = [];
  
  for (const cons of consequences) {
    switch(cons.type) {
      case 'add_disease':
        const player = cons.target;
        if (!player || !player.characteristics.health.revealed) continue;
        
        const diseases = parseHealthValue(player.characteristics.health.value);
        diseases.push({ name: cons.value, severity: 'легкая' });
        player.characteristics.health.value = formatHealthValue(diseases);
        results.push(`- ${player.name}: ${cons.value} (легкая)<br>`);
        break;
        
      case 'add_item':
        const target = cons.target === 'bunker' ? null : cons.target;
        if (target && !target.characteristics.inventory.revealed) continue;
        
        if (target) {
          const currentInv = target.characteristics.inventory.value;
          if (currentInv === '—' || !currentInv) {
            target.characteristics.inventory.value = cons.value;
          } else {
            target.characteristics.inventory.value = `${currentInv}, ${cons.value}`;
          }
          results.push(`- ${target.name}: +${cons.value}<br>`);
        } else {
          if (!game.bunkerResources) game.bunkerResources = [];
          game.bunkerResources.push(cons.value);
          results.push(`- Бункер: +${cons.value}<br>`);
        }
        break;
        
      case 'remove_item':
        const victim = cons.target;
        if (!victim || !victim.characteristics.inventory.revealed) continue;
        
        const items = victim.characteristics.inventory.value.split(',').map(i => i.trim());
        const newItems = items.filter(i => !i.includes(cons.value));
        
        if (newItems.length === 0) {
          victim.characteristics.inventory.value = '—';
        } else {
          victim.characteristics.inventory.value = newItems.join(', ');
        }
        results.push(`- ${victim.name}: потерян ${cons.value}<br>`);
        break;
        
      case 'maybe_remove_item':
        if (Math.random() >= cons.chance) continue;
        
        const maybeVictim = cons.target;
        if (!maybeVictim || !maybeVictim.characteristics.inventory.revealed) continue;
        
        const allItems = maybeVictim.characteristics.inventory.value.split(',').map(i => i.trim());
        const categoryItems = allItems.filter(i => 
          i.includes('еды') || i.includes('консерв') || i.includes('тушенк')
        );
        
        if (categoryItems.length > 0) {
          const lostItem = categoryItems[0];
          const filtered = allItems.filter(i => i !== lostItem);
          
          if (filtered.length === 0) {
            maybeVictim.characteristics.inventory.value = '—';
          } else {
            maybeVictim.characteristics.inventory.value = filtered.join(', ');
          }
          results.push(`- ${maybeVictim.name}: потерян ${lostItem}<br>`);
        }
        break;
    }
  }
  
  return results;
}
// =======================================================

// ============ ФУНКЦИЯ ДЛЯ ВЫЗОВА НЕЙРОСЕТИ ============
async function generateStoryFromFacts(facts, template, game) {
  
  // Формируем описание фактов для нейросети
  let factsDescription = '';
  
  switch(template.id) {
    case 'attack':
      factsDescription = `Факты события:
- На кого напали: ${facts.target.name}
- Кто напал: ${facts.threat}
- Где: ${facts.location}
- Травма: ${facts.injury}`;
      break;
      
    case 'find':
      factsDescription = `Факты события:
- Кто нашел: ${facts.hero.name}
- Что нашел: ${facts.item}
- Где нашел: ${facts.location}`;
      break;
      
    case 'find_with_risk':
      factsDescription = `Факты события:
- Кто нашел: ${facts.hero.name}
- Помощник: ${facts.helper.name}
- Первая находка: ${facts.item1}
- Вторая находка: ${facts.item2}
- Где нашли: ${facts.location}
- Кто пострадал: ${facts.injured.name}
- Травма: ${facts.injury}`;
      break;
      
    case 'break':
      factsDescription = `Факты события:
- У кого сломалось: ${facts.hero.name}
- Что сломалось: ${facts.item}
- Причина: ${facts.activity}`;
      break;
      
    case 'accident':
      factsDescription = `Факты события:
- Пострадавший: ${facts.hero.name}
- Где: ${facts.location}
- Травма: ${facts.injury}`;
      break;
      
    case 'theft':
      factsDescription = `Факты события:
- Жертва: ${facts.target.name}
- Вор: ${facts.threat}
- Что украли: ${facts.item}`;
      break;
      
    case 'discover_cache':
      factsDescription = `Факты события:
- Кто нашел: ${facts.hero.name}
- Где: ${facts.location}
- Первая находка: ${facts.item1}
- Вторая находка: ${facts.item2}`;
      break;
      
    case 'hunting':
      factsDescription = `Факты события:
- Охотник: ${facts.hero.name}
- Животное: ${facts.animal}
- Добыча: ${facts.item}
- Травма: ${facts.injury}`;
      break;
  }
  
  const prompt = `Ты генератор историй для игры "Бункер". На основе фактов напиши КОРОТКИЙ драматичный рассказ (4-5 предложений).

${factsDescription}

Напиши историю, используя эти факты. Не добавляй новых фактов. Пиши сухо, без пафоса, только события.`;

  // Пробуем разные модели
  for (const model of STORY_MODELS) {
    try {
      const story = await callModelWithTimeout(model, prompt, 15000);
      return story;
    } catch (error) {
      console.log(`❌ Модель ${model} не ответила:`, error.message);
    }
  }
  
  // Запасной вариант
  return generateFallbackStory(facts, template);
}
// =======================================================

// ============ ЗАПАСНОЙ ВАРИАНТ БЕЗ НЕЙРОСЕТИ ============
function generateFallbackStory(facts, template) {
  switch(template.id) {
    case 'attack':
      return `${facts.threat} напал на ${facts.target.name} в ${facts.location}. ${facts.target.name} отбился, но получил ${facts.injury}.`;
    case 'find':
      return `${facts.hero.name} нашел ${facts.item} в ${facts.location}.`;
    case 'find_with_risk':
      return `${facts.hero.name} и ${facts.helper.name} нашли ${facts.item1} и ${facts.item2} в ${facts.location}. ${facts.injured.name} получил ${facts.injury}.`;
    case 'break':
      return `У ${facts.hero.name} сломался ${facts.item} во время ${facts.activity}.`;
    case 'accident':
      return `${facts.hero.name} пострадал в ${facts.location}, получив ${facts.injury}.`;
    case 'theft':
      return `${facts.threat} украл у ${facts.target.name} ${facts.item}.`;
    case 'discover_cache':
      return `${facts.hero.name} нашел тайник в ${facts.location} с ${facts.item1} и ${facts.item2}.`;
    case 'hunting':
      return `${facts.hero.name} охотился на ${facts.animal} и добыл ${facts.item}, но получил ${facts.injury}.`;
    default:
      return `Случилось событие.`;
  }
}
// =======================================================

// ============ ОСНОВНАЯ ФУНКЦИЯ ГЕНЕРАЦИИ ============
async function generateEvent(game) {
  // Генерируем факты
  const result = generateEventFacts(game);
  if (!result) {
    throw new Error('Не удалось сгенерировать событие');
  }
  
  const { template, facts } = result;
  
  // Получаем последствия
  const consequences = template.possibleConsequences(facts);
  
  // Применяем последствия к игре
  const consequenceLines = applyConsequencesFromFacts(game, facts, consequences);
  
  // Генерируем историю через нейросеть
  let storyText;
  try {
    storyText = await generateStoryFromFacts(facts, template, game);
  } catch (error) {
    console.log('❌ Ошибка генерации истории, использую запасной вариант');
    storyText = generateFallbackStory(facts, template);
  }
  
  // Создаем событие
  const event = {
    id: uuidv4(),
    text: storyText,
    facts: facts, // Сохраняем факты для проверки повторов
    consequences: consequenceLines.join('\n'),
    timestamp: Date.now()
  };
  
  return event;
}
// =======================================================

// ============ API МАРШРУТ ДЛЯ ГЕНЕРАЦИИ ============
app.post('/api/generate-event', async (req, res) => {
  try {
    const { gameId } = req.body;
    const game = games.get(gameId);
    if (!game) {
      return res.status(404).json({ error: 'Игра не найдена' });
    }

    console.log(`🎮 Генерация события для игры ${gameId}`);

    // Генерируем событие
    const event = await generateEvent(game);

    if (!game.events) game.events = [];
    game.events.unshift(event);
    if (game.events.length > 20) game.events = game.events.slice(0, 20);

    // Сохраняем изменения
    games.set(gameId, game);
    saveData();
    
    // Отправляем обновление всем игрокам
    emitGameUpdateFixed(gameId);
    
    // Отправляем событие
    io.to(gameId).emit('newEvent', event);

    console.log(`✅ Событие успешно добавлено в игру ${gameId}`);
    res.json({ success: true, event });

  } catch (error) {
    console.error('❌ Ошибка генерации события:', error);
    res.status(500).json({ error: error.message });
  }
});

app.get('/api/events/:gameId', (req, res) => {
  const { gameId } = req.params;
  const game = games.get(gameId);

  if (!game) {
    return res.status(404).json({ error: 'Игра не найдена' });
  }

  res.json({ events: game.events || [] });
});


// Функция для вызова нейросети с таймаутом
async function callModelWithTimeout(model, prompt, timeoutMs = 20000) {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

  try {
    const response = await axios.post(
      'https://openrouter.ai/api/v1/chat/completions',
      {
        model: model,
        messages: [
          {
            role: 'user',
            content: prompt
          }
        ],
        temperature: 1,
        max_tokens: 2000
      },
      {
        headers: {
          'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
          'Content-Type': 'application/json',
          'HTTP-Referer': 'https://bunker-game-server.onrender.com',
          'X-Title': 'Bunker Game'
        },
        signal: controller.signal
      }
    );

    clearTimeout(timeoutId);
    return response.data.choices[0].message.content;
  } catch (error) {
    clearTimeout(timeoutId);
    throw error;
  }
}

// Функция для инициализации ресурсов бункера
function initializeBunkerResources(game) {
  game.bunkerResources = [];

  game.players.forEach(player => {
    if (player.characteristics.inventory.revealed &&
      player.characteristics.inventory.value &&
      player.characteristics.inventory.value !== '—') {

      const items = player.characteristics.inventory.value.split(',').map(i => i.trim());
      items.forEach(item => {
        if (item && item !== '—') {
          game.bunkerResources.push(item);
        }
      });
    }
  });

  console.log(`🏦 Инициализированы ресурсы бункера: ${game.bunkerResources.length} предметов`);
}




// Socket.IO
io.on('connection', (socket) => {
  console.log('Новое подключение:', socket.id);

  socket.on('joinGameRoomFixed', (gameId) => {
    socket.join(gameId);
    console.log(`Сокет ${socket.id} присоединился к комнате игры ${gameId}`);
  });

  socket.on('reconnectPlayer', ({ playerId }) => {
    console.log('Попытка восстановления игрока:', playerId);

    const existingSocket = [...activePlayers.entries()].find(([sid, p]) => p.id === playerId);
    if (existingSocket) {
      console.log('Игрок уже активен, отключаем старый socket');
      const [oldSocketId] = existingSocket;
      const oldSocket = io.sockets.sockets.get(oldSocketId);
      if (oldSocket) {
        oldSocket.disconnect();
      }
      activePlayers.delete(oldSocketId);
    }

    const gameId = playerGameMap.get(playerId);
    if (gameId) {
      const game = games.get(gameId);
      if (game) {
        const player = game.players.find(p => p.id === playerId);
        if (player) {
          player.socketId = socket.id;
          activePlayers.set(socket.id, player);
          socket.join(gameId);

          socket.emit('reconnectSuccess', {
            type: 'game',
            gameId: gameId,
            disaster: game.disaster,
            bunker: game.bunker,
            totalSlots: game.totalSlots,
            player: player,
            players: game.players,
            creatorId: game.creator,
            bunkerResources: game.bunkerResources || []
          });

          console.log('Игрок восстановлен в игре:', player.name);
          return;
        }
      }
    }

    for (const [lId, lobby] of lobbies) {
      const player = lobby.players.find(p => p.id === playerId);
      if (player) {
        player.socketId = socket.id;
        activePlayers.set(socket.id, player);
        socket.join(lId);

        if (lobby.gameId) {
          const game = games.get(lobby.gameId);
          if (game) {
            socket.emit('reconnectSuccess', {
              type: 'game',
              gameId: lobby.gameId,
              disaster: game.disaster,
              bunker: game.bunker,
              player: player,
              players: game.players,
              creatorId: game.creator,
              bunkerResources: game.bunkerResources || []
            });

            console.log('Игрок восстановлен в игре (через лобби):', player.name);
            return;
          }
        }

        socket.emit('reconnectSuccess', {
          type: 'lobby',
          lobbyId: lId,
          player: player,
          players: lobby.players
        });

        io.to(lId).emit('lobbyUpdate', { players: lobby.players });

        console.log('Игрок восстановлен в лобби:', player.name);
        return;
      }
    }

    socket.emit('reconnectFailed', { message: 'Игрок не найден' });
  });

  socket.on('checkPlayerActive', ({ playerId }) => {
    const isActive = [...activePlayers.values()].some(p => p.id === playerId);
    socket.emit('playerActiveCheck', { active: isActive });
  });

  socket.on('joinLobby', ({ lobbyId, playerName, isCreator }) => {
    console.log('Попытка входа в лобби:', lobbyId, playerName, 'isCreator:', isCreator);

    const lobby = lobbies.get(lobbyId);
    if (!lobby) {
      socket.emit('error', 'Лобби не найдено');
      return;
    }

    const existingPlayer = lobby.players.find(p => p.name === playerName);

    if (existingPlayer) {
      console.log('Игрок уже существует, обновляем соединение:', playerName);

      existingPlayer.socketId = socket.id;
      activePlayers.set(socket.id, existingPlayer);
      socket.join(lobbyId);

      if (lobby.gameId) {
        console.log('Игра уже началась, отправляем игрока сразу в игру');

        const game = games.get(lobby.gameId);
        if (game) {
          socket.emit('gameStarted', {
            gameId: game.id,
            disaster: game.disaster,
            bunker: game.bunker,
            player: existingPlayer,
            players: game.players,
            creatorId: game.creator,
            bunkerResources: game.bunkerResources || []
          });
        } else {
          socket.emit('joinedLobby', { lobbyId, player: existingPlayer, isCreator: lobby.creator === existingPlayer.id });
          io.to(lobbyId).emit('lobbyUpdate', { players: lobby.players, creatorId: lobby.creator });
        }
      } else {
        socket.emit('joinedLobby', { lobbyId, player: existingPlayer, isCreator: lobby.creator === existingPlayer.id });
        io.to(lobbyId).emit('lobbyUpdate', { players: lobby.players, creatorId: lobby.creator });
      }

      return;
    }

    const player = generatePlayer(playerName, socket.id);
    lobby.players.push(player);
    activePlayers.set(socket.id, player);

    if (isCreator || lobby.players.length === 1) {
      lobby.creator = player.id;
      console.log('Назначен создатель лобби:', player.name);
    }

    socket.join(lobbyId);
    socket.emit('joinedLobby', { lobbyId, player, isCreator: lobby.creator === player.id });
    io.to(lobbyId).emit('lobbyUpdate', { players: lobby.players, creatorId: lobby.creator });

    saveData();
    console.log('Новый игрок присоединился:', playerName);
  });

  socket.on('startGame', ({ lobbyId }) => {
    const lobby = lobbies.get(lobbyId);
    if (!lobby) {
      socket.emit('error', 'Лобби не найдено');
      return;
    }

    const player = lobby.players.find(p => p.socketId === socket.id);
    if (!player) {
      socket.emit('error', 'Игрок не найден в лобби');
      return;
    }

    if (player.id !== lobby.creator) {
      socket.emit('error', 'Только создатель лобби может начать игру');
      return;
    }

    if (lobby.players.length < 4) {
      socket.emit('error', 'Недостаточно игроков (нужно минимум 4)');
      return;
    }

    const gameId = uuidv4();
    const game = {
      id: gameId,
      disaster: GAME_DATA.disasters[Math.floor(Math.random() * GAME_DATA.disasters.length)],
      bunker: GAME_DATA.bunkers[Math.floor(Math.random() * GAME_DATA.bunkers.length)],
      players: lobby.players,
      status: 'active',
      created: Date.now(),
      lobbyId: lobbyId,
      creator: lobby.creator,
      totalSlots: calculateBunkerSlots(lobby.players.length),
      bunkerResources: [] // Инициализируем ресурсы бункера
    };

    // Инициализируем ресурсы бункера из инвентарей игроков
    initializeBunkerResources(game);

    games.set(gameId, game);
    lobby.status = 'game_started';
    lobby.gameId = gameId;

    game.players.forEach(player => {
      playerGameMap.set(player.id, gameId);
    });

    game.players.forEach(player => {
      const playerSocket = io.sockets.sockets.get(player.socketId);
      if (playerSocket) {
        playerSocket.join(gameId);
      }

      io.to(player.socketId).emit('gameStarted', {
        gameId: game.id,
        disaster: game.disaster,
        bunker: game.bunker,
        totalSlots: game.totalSlots,
        player: player,
        players: game.players,
        isCreator: player.id === lobby.creator,
        creatorId: game.creator,
        bunkerResources: game.bunkerResources
      });
    });

    saveData();
    console.log('Игра создана:', gameId);
  });

  socket.on('getGameData', ({ gameId }) => {
    const game = games.get(gameId);
    if (!game) {
      socket.emit('error', 'Игра не найдена');
      return;
    }

    const player = game.players.find(p => p.socketId === socket.id);
    if (!player) return;

    socket.emit('gameData', {
      gameId: game.id,
      disaster: game.disaster,
      bunker: game.bunker,
      totalSlots: game.totalSlots,
      player: player,
      players: game.players,
      isCreator: player.id === game.creator,
      creatorId: game.creator,
      bunkerResources: game.bunkerResources || []
    });
  });

  socket.on('revealCharacteristic', ({ gameId, characteristic }) => {
    const game = games.get(gameId);
    if (!game) return;

    const player = game.players.find(p => p.socketId === socket.id);
    if (!player) return;

    player.characteristics[characteristic].revealed = true;

    const savedPlayer = playersDataMap.get(player.id);
    if (savedPlayer) {
      savedPlayer.characteristics[characteristic].revealed = true;
    }

    // Если раскрыли инвентарь, добавляем предметы в ресурсы бункера
    if (characteristic === 'inventory' && game.bunkerResources) {
      const items = parseCharacteristicValue('inventory', player.characteristics.inventory.value);
      const allItems = [items.main, ...items.items].filter(i => i && i !== '—');

      allItems.forEach(item => {
        if (!game.bunkerResources.includes(item)) {
          game.bunkerResources.push(item);
        }
      });

      console.log(`🏦 Предметы игрока ${player.name} добавлены в ресурсы бункера`);
    }

    game.players.forEach(p => {
      io.to(p.socketId).emit('characteristicRevealed', {
        playerId: player.id,
        characteristic,
        value: player.characteristics[characteristic].value,
        revealedBy: player.name
      });
    });

    emitGameUpdateFixed(gameId);
    saveData();
  });

  socket.on('kickPlayer', ({ gameId, playerIdToKick }) => {
    const game = games.get(gameId);
    if (!game) {
      socket.emit('error', 'Игра не найдена');
      return;
    }

    const initiator = game.players.find(p => p.socketId === socket.id);
    if (!initiator || initiator.id !== game.creator) {
      socket.emit('error', 'Только создатель может изгонять игроков');
      return;
    }

    const playerToKick = game.players.find(p => p.id === playerIdToKick);
    if (!playerToKick) {
      socket.emit('error', 'Игрок не найден');
      return;
    }

    playerToKick.status = 'kicked';
    playerToKick.statusMessage = 'изгнан';

    games.set(gameId, game);
    emitGameUpdateFixed(gameId);
    saveData();
    console.log(`В игре ${gameId} игрок ${playerToKick.name} изгнан создателем ${initiator.name}`);
  });

  socket.on('markDead', ({ gameId, playerIdToMark }) => {
    const game = games.get(gameId);
    if (!game) {
      socket.emit('error', 'Игра не найдена');
      return;
    }

    const initiator = game.players.find(p => p.socketId === socket.id);
    if (!initiator || initiator.id !== game.creator) {
      socket.emit('error', 'Только создатель может отмечать игроков мертвыми');
      return;
    }

    const playerToMark = game.players.find(p => p.id === playerIdToMark);
    if (!playerToMark) {
      socket.emit('error', 'Игрок не найден');
      return;
    }

    playerToMark.status = 'dead';
    playerToMark.statusMessage = 'мертв';

    games.set(gameId, game);
    emitGameUpdateFixed(gameId);
    saveData();
    console.log(`В игре ${gameId} игрок ${playerToMark.name} отмечен мертвым создателем ${initiator.name}`);
  });

  socket.on('restorePlayer', ({ gameId, playerIdToRestore }) => {
    const game = games.get(gameId);
    if (!game) {
      socket.emit('error', 'Игра не найдена');
      return;
    }

    const initiator = game.players.find(p => p.socketId === socket.id);
    if (!initiator || initiator.id !== game.creator) {
      socket.emit('error', 'Только создатель может восстанавливать игроков');
      return;
    }

    const playerToRestore = game.players.find(p => p.id === playerIdToRestore);
    if (!playerToRestore) {
      socket.emit('error', 'Игрок не найден');
      return;
    }

    delete playerToRestore.status;
    delete playerToRestore.statusMessage;

    games.set(gameId, game);
    emitGameUpdateFixed(gameId);
    saveData();
    console.log(`В игре ${gameId} игрок ${playerToRestore.name} восстановлен создателем ${initiator.name}`);
  });

  socket.on('transferCreator', ({ gameId, newCreatorId }) => {
    const game = games.get(gameId);
    if (!game) {
      socket.emit('error', 'Игра не найдена');
      return;
    }

    const initiator = game.players.find(p => p.socketId === socket.id);
    if (!initiator || initiator.id !== game.creator) {
      socket.emit('error', 'Только создатель может передавать права');
      return;
    }

    const newCreator = game.players.find(p => p.id === newCreatorId);
    if (!newCreator) {
      socket.emit('error', 'Игрок не найден');
      return;
    }

    game.creator = newCreatorId;

    games.set(gameId, game);
    emitGameUpdateFixed(gameId);
    io.to(newCreator.socketId).emit('youAreNowCreator');

    saveData();
    console.log(`В игре ${gameId} права создателя переданы от ${initiator.name} к ${newCreator.name}`);
  });

  // ============ ОБРАБОТЧИКИ ДЛЯ ЗДОРОВЬЯ ============
  socket.on('changeHealth', ({ gameId, playerId, action, diseaseName, severity }) => {
    console.log('changeHealth called:', { gameId, playerId, action, diseaseName, severity });

    const game = games.get(gameId);
    if (!game) {
      socket.emit('error', 'Игра не найдена');
      return;
    }

    const initiator = game.players.find(p => p.socketId === socket.id);
    if (!initiator || initiator.id !== game.creator) {
      socket.emit('error', 'Только создатель может изменять здоровье');
      return;
    }

    const targetPlayer = game.players.find(p => p.id === playerId);
    if (!targetPlayer) {
      socket.emit('error', 'Игрок не найден');
      return;
    }

    let newHealthValue;

    switch (action) {
      case 'random':
        newHealthValue = getRandomHealth();
        break;

      case 'select':
        if (!diseaseName) {
          socket.emit('error', 'Не выбрана болезнь');
          return;
        }
        if (diseaseName === 'Здоров') {
          newHealthValue = 'Здоров';
        } else {
          const sev = severity || getRandomSeverity();
          newHealthValue = `${diseaseName} (${sev})`;
        }
        break;

      case 'add':
        if (!diseaseName) {
          socket.emit('error', 'Не выбрана болезнь');
          return;
        }

        const currentDiseases = parseHealthValue(targetPlayer.characteristics.health.value);

        currentDiseases.push({
          name: diseaseName,
          severity: severity || getRandomSeverity()
        });

        newHealthValue = formatHealthValue(currentDiseases);
        break;

      default:
        socket.emit('error', 'Неизвестное действие');
        return;
    }

    targetPlayer.characteristics.health.value = newHealthValue;

    games.set(gameId, game);
    emitGameUpdateFixed(gameId);
    saveData();

    console.log(`Создатель изменил здоровье игрока ${targetPlayer.name} на ${newHealthValue}`);
  });

  socket.on('removeHealth', ({ gameId, playerId, index }) => {
    console.log('removeHealth called:', { gameId, playerId, index });

    const game = games.get(gameId);
    if (!game) {
      socket.emit('error', 'Игра не найдена');
      return;
    }

    const initiator = game.players.find(p => p.socketId === socket.id);
    if (!initiator || initiator.id !== game.creator) {
      socket.emit('error', 'Только создатель может удалять здоровье');
      return;
    }

    const targetPlayer = game.players.find(p => p.id === playerId);
    if (!targetPlayer) {
      socket.emit('error', 'Игрок не найден');
      return;
    }

    const diseases = parseHealthValue(targetPlayer.characteristics.health.value);

    if (index < 0 || index >= diseases.length) {
      socket.emit('error', `Неверный индекс болезни. Индекс: ${index}, всего болезней: ${diseases.length}`);
      return;
    }

    diseases.splice(index, 1);

    targetPlayer.characteristics.health.value = formatHealthValue(diseases);

    games.set(gameId, game);
    emitGameUpdateFixed(gameId);
    saveData();

    console.log(`Создатель удалил болезнь у игрока ${targetPlayer.name}`);
  });

  // ============ ОБРАБОТЧИКИ ДЛЯ ХАРАКТЕРИСТИК ============
  socket.on('changeCharacteristic', ({ gameId, playerId, characteristic, action, value, index }) => {
    console.log('changeCharacteristic called:', { gameId, playerId, characteristic, action, value, index });

    const game = games.get(gameId);
    if (!game) {
      socket.emit('error', 'Игра не найдена');
      return;
    }

    const initiator = game.players.find(p => p.socketId === socket.id);
    if (!initiator || initiator.id !== game.creator) {
      socket.emit('error', 'Только создатель может изменять характеристики');
      return;
    }

    const targetPlayer = game.players.find(p => p.id === playerId);
    if (!targetPlayer) {
      socket.emit('error', 'Игрок не найден');
      return;
    }

    const currentValue = targetPlayer.characteristics[characteristic].value;
    const parsed = parseCharacteristicValue(characteristic, currentValue);
    let newValue;

    switch (action) {
      case 'random':
        newValue = getRandomValue(characteristic, currentValue);
        break;

      case 'select':
        if (!value) {
          socket.emit('error', 'Не выбрано значение');
          return;
        }
        if (characteristic === 'profession') {
          const prof = GAME_DATA.characteristics.professions.find(p => p.name === value);
          if (prof) {
            const experience = Math.floor(Math.random() * 20) + 1;
            newValue = `${prof.name} (стаж ${experience} лет)`;
          } else {
            newValue = value;
          }
        } else {
          newValue = value;
        }
        break;

      case 'add':
        if (!value) {
          socket.emit('error', 'Не выбрано значение');
          return;
        }
        if (characteristic === 'profession' || characteristic === 'gender') {
          socket.emit('error', 'Нельзя добавлять к этой характеристике');
          return;
        }
        newValue = formatCharacteristicValue(characteristic, parsed.main, [...parsed.items, value]);
        break;

      case 'remove':
        if (index === undefined || index < 0) {
          socket.emit('error', 'Не указан элемент для удаления');
          return;
        }

        if (characteristic === 'profession' || characteristic === 'gender') {
          socket.emit('error', 'Нельзя удалять части этой характеристики');
          return;
        }

        if (index === 0) {
          if (parsed.items.length > 0) {
            newValue = formatCharacteristicValue(characteristic, parsed.items[0], parsed.items.slice(1));
          } else {
            newValue = '—';
          }
        } else {
          const itemIndex = index - 1;
          if (itemIndex >= 0 && itemIndex < parsed.items.length) {
            const newItems = [...parsed.items];
            newItems.splice(itemIndex, 1);
            newValue = formatCharacteristicValue(characteristic, parsed.main, newItems);
          } else {
            socket.emit('error', 'Элемент не найден');
            return;
          }
        }
        break;

      default:
        socket.emit('error', 'Неизвестное действие');
        return;
    }

    targetPlayer.characteristics[characteristic].value = newValue;

    // Если изменили инвентарь, обновляем ресурсы бункера
    if (characteristic === 'inventory' && game.bunkerResources) {
      // Переинициализируем ресурсы бункера
      initializeBunkerResources(game);
    }

    games.set(gameId, game);
    emitGameUpdateFixed(gameId);
    saveData();

    console.log(`Создатель изменил характеристику ${characteristic} игрока ${targetPlayer.name}`);
  });

  // ============ ОБРАБОТЧИКИ ДЛЯ ГОЛОСОВАНИЯ ============
  socket.on('startVoting', ({ gameId }) => {
    const game = games.get(gameId);
    if (!game) {
      socket.emit('error', 'Игра не найдена');
      return;
    }

    const initiator = game.players.find(p => p.socketId === socket.id);
    if (!initiator || initiator.id !== game.creator) {
      socket.emit('error', 'Только создатель может начать голосование');
      return;
    }

    if (game.voting && game.voting.active) {
      socket.emit('error', 'Голосование уже идет');
      return;
    }

    if (startVoting(gameId, initiator.id)) {
      io.to(gameId).emit('votingStarted', {
        endTime: Date.now() + 15000,
        initiatorName: initiator.name
      });
      console.log(`Создатель ${initiator.name} начал голосование в игре ${gameId}`);
    }
  });

  socket.on('cancelVoting', ({ gameId }) => {
    const game = games.get(gameId);
    if (!game) {
      socket.emit('error', 'Игра не найдена');
      return;
    }

    const initiator = game.players.find(p => p.socketId === socket.id);
    if (!initiator || initiator.id !== game.creator) {
      socket.emit('error', 'Только создатель может отменить голосование');
      return;
    }

    if (cancelVoting(gameId)) {
      io.to(gameId).emit('votingCancelled');
      console.log(`Создатель ${initiator.name} отменил голосование в игре ${gameId}`);
    }
  });

  socket.on('castVote', ({ gameId, votedForId }) => {
    const game = games.get(gameId);
    if (!game) {
      socket.emit('error', 'Игра не найдена');
      return;
    }

    if (!game.voting || !game.voting.active) {
      socket.emit('error', 'Голосование не активно');
      return;
    }

    const voter = game.players.find(p => p.socketId === socket.id);
    if (!voter) {
      socket.emit('error', 'Игрок не найден');
      return;
    }

    if (game.voting.voters.has(voter.id)) {
      socket.emit('error', 'Вы уже проголосовали');
      return;
    }

    const votedFor = game.players.find(p => p.id === votedForId);
    if (!votedFor) {
      socket.emit('error', 'Игрок не найден');
      return;
    }

    game.voting.votes[voter.id] = votedForId;
    game.voting.voters.add(voter.id);

    games.set(gameId, game);

    io.to(gameId).emit('voteCast', {
      voterName: voter.name,
      totalVotes: game.voting.voters.size
    });

    console.log(`Игрок ${voter.name} проголосовал в игре ${gameId}`);
  });

  socket.on('getVotingStatus', ({ gameId }) => {
    const game = games.get(gameId);
    if (!game) return;

    if (game.voting && game.voting.active) {
      socket.emit('votingStatus', {
        active: true,
        endTime: game.voting.endTime,
        totalVotes: game.voting.voters.size
      });
    } else {
      socket.emit('votingStatus', { active: false });
    }
  });

  socket.on('disconnect', () => {
    console.log('Отключение:', socket.id);
    const player = activePlayers.get(socket.id);
    if (player) {
      console.log('Игрок отключился:', player.name);
      activePlayers.delete(socket.id);
    }
  });
});

const PORT = process.env.PORT || 3000;
server.listen(PORT, () => {
  console.log(`Сервер запущен на порту ${PORT}`);
});